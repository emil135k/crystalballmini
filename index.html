<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Crystal Ball Mini V5.2</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap');

```
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

:root {
  --bg-deep: #0a0a14;
  --bg-dark: #12121f;
  --bg-card: #1a1a2e;
  --bg-elevated: #242442;
  --accent-purple: #9d4edd;
  --accent-blue: #3a86ff;
  --accent-green: #06d6a0;
  --accent-amber: #f59e0b;
  --accent-red: #ef4444;
  --accent-cyan: #22d3ee;
  --text-primary: #f0f0f5;
  --text-secondary: #888899;
  --text-muted: #555566;
  --border: #2a2a45;
}

body {
  font-family: 'Space Grotesk', -apple-system, sans-serif;
  background: var(--bg-deep);
  color: var(--text-primary);
  min-height: 100vh;
  padding: 12px;
  padding-bottom: 100px;
}

/* === HEADER === */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0 16px 0;
}
.logo {
  display: flex;
  align-items: center;
  gap: 8px;
}
.logo-icon { font-size: 1.8em; }
.logo-text h1 {
  font-size: 1.2em;
  font-weight: 700;
  color: var(--accent-purple);
  letter-spacing: -0.5px;
}
.logo-text .version {
  font-size: 0.65em;
  color: var(--text-muted);
  font-family: 'JetBrains Mono', monospace;
}
.save-indicator {
  font-size: 0.7em;
  color: var(--accent-green);
  font-family: 'JetBrains Mono', monospace;
}

/* === TAB BAR === */
.tab-bar {
  display: flex;
  gap: 4px;
  background: var(--bg-dark);
  padding: 4px;
  border-radius: 12px;
  margin-bottom: 16px;
}
.tab-btn {
  flex: 1;
  padding: 10px 8px;
  background: transparent;
  border: none;
  border-radius: 8px;
  color: var(--text-secondary);
  font-family: inherit;
  font-size: 0.75em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}
.tab-btn .icon { font-size: 1.3em; }
.tab-btn.active {
  background: var(--bg-elevated);
  color: var(--accent-purple);
}

/* === CARDS === */
.card {
  background: var(--bg-card);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  border: 1px solid var(--border);
}
.card-title {
  font-size: 0.75em;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 12px;
}

/* === SUMMARY CARDS === */
.summary-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 12px;
}
.summary-card {
  background: var(--bg-elevated);
  border-radius: 10px;
  padding: 12px;
  text-align: center;
}
.summary-card .label {
  font-size: 0.65em;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.summary-card .value {
  font-size: 1.5em;
  font-weight: 700;
  font-family: 'JetBrains Mono', monospace;
  margin-top: 4px;
}
.summary-card .value.good { color: var(--accent-green); }
.summary-card .value.warning { color: var(--accent-amber); }
.summary-card .value.danger { color: var(--accent-red); }

/* === FORM ELEMENTS === */
.form-group {
  margin-bottom: 12px;
}
.form-group label {
  display: block;
  font-size: 0.75em;
  color: var(--text-secondary);
  margin-bottom: 4px;
}
input, select {
  width: 100%;
  padding: 10px 12px;
  background: var(--bg-dark);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-primary);
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.9em;
}
input:focus, select:focus {
  outline: none;
  border-color: var(--accent-purple);
}
.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}
.form-row-3 {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 8px;
}

/* === BUTTONS === */
.btn {
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  font-family: inherit;
  font-size: 0.85em;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
.btn-primary {
  background: var(--accent-purple);
  color: white;
}
.btn-success {
  background: var(--accent-green);
  color: var(--bg-deep);
}
.btn-danger {
  background: var(--accent-red);
  color: white;
}
.btn-secondary {
  background: var(--bg-elevated);
  color: var(--text-primary);
}
.btn:hover { opacity: 0.9; transform: translateY(-1px); }
.btn-row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

/* === S/D TOGGLE === */
.event-type-toggle {
  display: flex;
  gap: 4px;
  background: var(--bg-dark);
  padding: 4px;
  border-radius: 8px;
}
.event-type-toggle button {
  flex: 1;
  padding: 8px 12px;
  border: none;
  border-radius: 6px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.85em;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  background: transparent;
  color: var(--text-muted);
}
.event-type-toggle button.active-stop {
  background: var(--accent-cyan);
  color: var(--bg-deep);
}
.event-type-toggle button.active-drive {
  background: var(--accent-green);
  color: var(--bg-deep);
}

/* === EVENT LIST === */
.event-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.event-item {
  background: var(--bg-elevated);
  border-radius: 8px;
  padding: 12px;
  display: grid;
  grid-template-columns: auto 1fr auto;
  gap: 12px;
  align-items: center;
}
.event-badge {
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 0.7em;
  font-weight: 600;
  text-transform: uppercase;
}
.event-badge.drive { background: var(--accent-blue); color: white; }
.event-badge.on-duty { background: var(--accent-amber); color: var(--bg-deep); }
.event-badge.off-duty { background: var(--accent-green); color: var(--bg-deep); }
.event-badge.sleeper { background: var(--accent-purple); color: white; }
.event-badge.yard { background: var(--accent-cyan); color: var(--bg-deep); }
.event-badge.pc { background: var(--text-muted); color: white; }

.event-details {
  font-size: 0.85em;
}
.event-details .time {
  font-family: 'JetBrains Mono', monospace;
  color: var(--text-primary);
}
.event-details .info {
  color: var(--text-secondary);
  font-size: 0.9em;
}
.event-delete {
  background: none;
  border: none;
  color: var(--accent-red);
  cursor: pointer;
  font-size: 1.2em;
  opacity: 0.6;
}
.event-delete:hover { opacity: 1; }

/* === RUN/LEG HIERARCHY === */
.hierarchy-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}
.run-badge {
  background: var(--accent-purple);
  color: white;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 0.8em;
  font-weight: 600;
  font-family: 'JetBrains Mono', monospace;
}
.leg-badge {
  background: var(--accent-blue);
  color: white;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 0.75em;
  font-weight: 600;
}
.stop-ref {
  font-family: 'JetBrains Mono', monospace;
  color: var(--accent-cyan);
  font-size: 0.8em;
}

/* === CALCULATED STATS === */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--border);
}
.stat-item {
  text-align: center;
}
.stat-item .label {
  font-size: 0.6em;
  color: var(--text-muted);
  text-transform: uppercase;
}
.stat-item .value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.9em;
  color: var(--accent-green);
}

/* === TAB CONTENT === */
.tab-content { display: none; }
.tab-content.active { display: block; }

/* === FOOTER === */
footer {
  text-align: center;
  padding: 20px;
  font-size: 0.7em;
  color: var(--text-muted);
}
footer .brand { color: var(--accent-purple); font-weight: 600; }

/* === RECORDS TABLE === */
.records-table {
  width: 100%;
  min-width: 700px;
  border-collapse: collapse;
  font-size: 0.75em;
  font-family: 'JetBrains Mono', monospace;
}
.records-table th {
  padding: 8px;
  background: var(--bg-elevated);
  text-align: left;
  white-space: nowrap;
}
.records-table td {
  padding: 8px;
  border-bottom: 1px solid var(--border);
}
.records-table tr:hover {
  background: var(--bg-elevated);
  cursor: pointer;
}
```

  </style>
</head>
<body>

<!-- HEADER -->

<header class="header">
  <div class="logo">
    <span class="logo-icon">üîÆ</span>
    <div class="logo-text">
      <h1>Crystal Ball Mini</h1>
      <span class="version">V5.2 ‚Äî Live Stats Dashboard!</span>
    </div>
  </div>
  <span class="save-indicator" id="saveIndicator">üíæ Auto-saved</span>
</header>

<!-- TAB BAR - PROPHECY instead of Theory! -->

<nav class="tab-bar">
  <button class="tab-btn active" onclick="switchTab('entry')">
    <span class="icon">üìù</span>
    <span>Entry</span>
  </button>
  <button class="tab-btn" onclick="switchTab('prophecy')">
    <span class="icon">üîÆ</span>
    <span>Prophecy</span>
  </button>
  <button class="tab-btn" onclick="switchTab('timeline')">
    <span class="icon">üìä</span>
    <span>Timeline</span>
  </button>
  <button class="tab-btn" onclick="switchTab('recaps')">
    <span class="icon">üîÑ</span>
    <span>Recaps</span>
  </button>
  <button class="tab-btn" onclick="switchTab('settings')">
    <span class="icon">‚öôÔ∏è</span>
    <span>Settings</span>
  </button>
</nav>

<!-- TAB: ENTRY -->

<div id="tab-entry" class="tab-content active">

  <!-- Current Run/Leg Display -->

  <div class="card">
    <div class="hierarchy-header">
      <div>
        <span class="run-badge" id="currentRunBadge">RUN: ---</span>
        <span class="leg-badge" id="currentLegBadge" style="margin-left: 8px;">LEG: ---</span>
      </div>
      <span class="stop-ref" id="nextStopRef">Next: L1-S1</span>
    </div>

```
<!-- Summary Stats -->
<div class="summary-row">
  <div class="summary-card">
    <div class="label">Cycle Available</div>
    <div class="value good" id="cycleAvail">70:00</div>
  </div>
  <div class="summary-card">
    <div class="label">14-Hr Available</div>
    <div class="value good" id="windowRemain">14:00</div>
  </div>
</div>
<div class="summary-row">
  <div class="summary-card">
    <div class="label">Drive Remaining</div>
    <div class="value good" id="driveRemain">11:00</div>
  </div>
  <div class="summary-card">
    <div class="label">Miles This Run</div>
    <div class="value" id="milesRun">0</div>
  </div>
</div>
<div class="summary-row">
  <div class="summary-card">
    <div class="label">Avg MPH (Run)</div>
    <div class="value" id="avgMphRun">--</div>
  </div>
  <div class="summary-card">
    <div class="label">Must Stop By</div>
    <div class="value" id="windowEnds" style="font-size: 1.1em;">--:--</div>
  </div>
</div>
```

  </div>

  <!-- New Event Entry -->

  <div class="card">
    <div class="card-title">Event Entry</div>

```
<!-- Mode Toggle -->
<div style="display: flex; gap: 8px; margin-bottom: 16px; padding: 8px; background: var(--bg-elevated); border-radius: 8px;">
  <button id="modeAddBtn" class="btn btn-success" style="flex: 1; padding: 10px;" onclick="setMode('add')">‚ûï ADD</button>
  <button id="modeEditBtn" class="btn btn-secondary" style="flex: 1; padding: 10px;" onclick="setMode('edit')">‚úèÔ∏è EDIT</button>
</div>
<p id="modeStatus" style="font-size: 0.75em; color: var(--text-muted); margin-bottom: 12px; text-align: center;">Adding new record at L1-S1</p>

<div class="form-group">
  <label>Run ID <span style="color: var(--accent-red);">*</span></label>
  <input type="text" id="inputRunId" placeholder="REQUIRED: Load #, trip name, etc.">
</div>

<div class="form-row">
  <div class="form-group">
    <label>Current Leg</label>
    <div style="display: flex; align-items: center; gap: 4px;">
      <button type="button" class="btn btn-secondary" onclick="prevLeg()" style="padding: 6px 10px; font-size: 0.75em;">‚óÄ</button>
      <span id="currentLegDisplay" style="font-family: 'JetBrains Mono', monospace; font-size: 1.2em; color: var(--accent-blue); font-weight: 700; min-width: 40px; text-align: center;">L1</span>
      <button type="button" class="btn btn-secondary" onclick="nextLeg()" style="padding: 6px 10px; font-size: 0.75em;">‚ñ∂</button>
    </div>
  </div>
  <div class="form-group">
    <label>Current Event</label>
    <div style="display: flex; align-items: center; gap: 4px;">
      <button type="button" class="btn btn-secondary" onclick="prevEvent()" style="padding: 6px 10px; font-size: 0.75em;">‚óÄ</button>
      <span id="currentEventDisplay" style="font-family: 'JetBrains Mono', monospace; font-size: 1.2em; color: var(--accent-cyan); font-weight: 700; min-width: 40px; text-align: center;">S1</span>
      <button type="button" class="btn btn-secondary" onclick="nextEvent()" style="padding: 6px 10px; font-size: 0.75em;">‚ñ∂</button>
    </div>
  </div>
</div>

<!-- S/D Toggle - NEW! -->
<div class="form-group">
  <label>Event Type</label>
  <div class="event-type-toggle">
    <button id="toggleStop" class="active-stop" onclick="setEventType('S')">üõë S (Stop)</button>
    <button id="toggleDrive" onclick="setEventType('D')">üöõ D (Drive)</button>
  </div>
</div>

<div class="form-row">
  <div class="form-group">
    <label>Category (HOS)</label>
    <select id="inputCategory">
      <option value="drive">üöõ Drive</option>
      <option value="on-duty">üìã On-Duty</option>
      <option value="off-duty" selected>‚òï Off-Duty</option>
      <option value="sleeper">üò¥ Sleeper Berth</option>
      <option value="yard">üÖøÔ∏è Yard Move</option>
      <option value="pc">üöó PC (Personal Conv.)</option>
    </select>
  </div>
  <div class="form-group">
    <label>Stop Type</label>
    <select id="inputStopType">
      <option value="event" selected>üìç Event</option>
      <option value="shipper">üì¶ Shipper</option>
      <option value="receiver">üè≠ Receiver</option>
      <option value="noload">üÖøÔ∏è No-Load</option>
    </select>
  </div>
</div>

<div class="form-row-3">
  <div class="form-group">
    <label>Start Time</label>
    <input type="time" id="inputStartTime" onchange="autoCalcEndTime()">
  </div>
  <div class="form-group">
    <label>Duration (min)</label>
    <input type="number" id="inputDuration" placeholder="Auto" onchange="autoCalcEndTime()">
  </div>
  <div class="form-group">
    <label>End Time</label>
    <input type="time" id="inputEndTime" onchange="autoCalcDuration()">
  </div>
</div>

<div class="form-row">
  <div class="form-group">
    <label>Miles (Cumulative)</label>
    <input type="number" id="inputMiles" placeholder="e.g., 285">
  </div>
  <div class="form-group">
    <label>Date</label>
    <input type="date" id="inputDate">
  </div>
</div>

<div class="form-group">
  <label>Comment (optional)</label>
  <input type="text" id="inputComment" placeholder="e.g., Fuel stop at Loves #482">
</div>

<div class="btn-row" id="formButtons">
  <button id="btnSubmit" class="btn btn-success" onclick="submitRecord()">‚úì Enter Record</button>
  <button class="btn btn-secondary" onclick="clearForm()">Clear</button>
</div>

<!-- Delete Section - Only visible in EDIT mode -->
<div id="deleteSection" style="display: none; margin-top: 16px; padding: 12px; background: #2d1f1f; border: 1px solid var(--accent-red); border-radius: 8px;">
  <p style="color: var(--accent-red); font-size: 0.85em; margin-bottom: 8px;">‚ö†Ô∏è Delete this record?</p>
  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 12px;">
    <input type="checkbox" id="confirmDeleteCheckbox" onchange="toggleDeleteButton()" style="width: 20px; height: 20px; cursor: pointer;">
    <span style="font-size: 0.8em; color: var(--text-secondary);">I confirm I want to delete <span id="deleteLocDisplay">L1-S1</span></span>
  </label>
  <button id="btnDeleteConfirmed" class="btn btn-danger" style="width: 100%; opacity: 0.5;" onclick="executeDelete()" disabled>üóëÔ∏è Delete Record</button>
</div>
```

  </div>

  <!-- Records Table -->

  <div class="card">
    <div class="card-title">üìã Entered Records</div>
    <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
      <table class="records-table" id="recordsTable">
        <thead>
          <tr>
            <th style="color: var(--accent-purple);">Run</th>
            <th style="color: var(--accent-blue);">Leg</th>
            <th style="color: var(--accent-cyan);">Evt</th>
            <th>Cat</th>
            <th style="color: var(--accent-amber);">Type</th>
            <th>Date/Start</th>
            <th>Date/End</th>
            <th>Dur</th>
            <th>Mi</th>
            <th>Comment</th>
          </tr>
        </thead>
        <tbody id="recordsTableBody">
          <tr>
            <td colspan="10" style="padding: 20px; text-align: center; color: var(--text-muted);">No records yet. Enter your first record above!</td>
          </tr>
        </tbody>
      </table>
    </div>
    <p style="font-size: 0.7em; color: var(--text-muted); margin-top: 8px;">‚ÜîÔ∏è Swipe table ‚Ä¢ Click row to edit</p>
  </div>
</div>

<!-- TAB: PROPHECY (was Theory) -->

<div id="tab-prophecy" class="tab-content">
  <div class="card">
    <div class="card-title">üîÆ Trip Generator</div>
    <p style="font-size: 0.8em; color: var(--text-secondary); margin-bottom: 16px;">
      Deadhead ‚Üí Shipper ‚Üí Receiver ‚Ä¢ Full HOS-compliant timeline
    </p>

```
<!-- DISTANCE INPUTS -->
<div style="background: var(--bg-elevated); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
  <div style="font-size: 0.7em; color: var(--accent-cyan); margin-bottom: 8px; text-transform: uppercase;">üìç Distances</div>
  <div class="form-row">
    <div class="form-group" style="margin-bottom: 0;">
      <label>Deadhead (to Shipper)</label>
      <input type="number" id="theoryDeadheadMiles" value="150" min="0" oninput="updateTripPreview()">
    </div>
    <div class="form-group" style="margin-bottom: 0;">
      <label>Loaded (Shipper ‚Üí Receiver)</label>
      <input type="number" id="theoryLoadedMiles" value="1650" min="0" oninput="updateTripPreview()">
    </div>
  </div>
  <div style="text-align: center; margin-top: 8px; font-size: 0.9em;">
    Total: <span id="previewTotalMiles" style="color: var(--accent-green); font-weight: 700;">1800</span> miles
  </div>
</div>

<!-- SHIPPER INFO -->
<div style="background: var(--bg-elevated); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
  <div style="font-size: 0.7em; color: var(--accent-amber); margin-bottom: 8px; text-transform: uppercase;">üì¶ Shipper (Pickup)</div>
  <div class="form-group" style="margin-bottom: 8px;">
    <label>Appointment Date</label>
    <input type="date" id="theoryShipperDate" value="2026-01-17">
  </div>
  <div class="form-row">
    <div class="form-group" style="margin-bottom: 0;">
      <label>Window Early</label>
      <input type="time" id="theoryShipperEarly" value="06:00">
    </div>
    <div class="form-group" style="margin-bottom: 0;">
      <label>Window Late</label>
      <input type="time" id="theoryShipperLate" value="08:00">
    </div>
  </div>
  <div class="form-group" style="margin-top: 8px; margin-bottom: 8px;">
    <label>Secure/Tarp Time (min)</label>
    <input type="number" id="theorySecureTarpMin" value="30" min="0">
  </div>
  <div style="background: var(--bg-dark); padding: 10px; border-radius: 6px; margin-top: 8px;">
    <div style="font-size: 0.7em; color: var(--text-muted);">CALCULATED ETA</div>
    <div id="shipperCalcETA" style="font-size: 1.1em; font-weight: 700; color: var(--accent-amber);">-- Generate trip --</div>
    <div id="shipperCalcStatus" style="font-size: 0.8em; margin-top: 4px;">--</div>
  </div>
</div>

<!-- RECEIVER INFO -->
<div style="background: var(--bg-elevated); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
  <div style="font-size: 0.7em; color: var(--accent-purple); margin-bottom: 8px; text-transform: uppercase;">üè≠ Receiver (Delivery)</div>
  <div class="form-group" style="margin-bottom: 8px;">
    <label>Appointment Date</label>
    <input type="date" id="theoryReceiverDate" value="2026-01-19">
  </div>
  <div class="form-row">
    <div class="form-group" style="margin-bottom: 0;">
      <label>Window Early</label>
      <input type="time" id="theoryReceiverEarly" value="08:00">
    </div>
    <div class="form-group" style="margin-bottom: 0;">
      <label>Window Late</label>
      <input type="time" id="theoryReceiverLate" value="16:00">
    </div>
  </div>
  <div style="background: var(--bg-dark); padding: 10px; border-radius: 6px; margin-top: 8px;">
    <div style="font-size: 0.7em; color: var(--text-muted);">CALCULATED ETA</div>
    <div id="receiverCalcETA" style="font-size: 1.1em; font-weight: 700; color: var(--accent-purple);">-- Generate trip --</div>
    <div id="receiverCalcStatus" style="font-size: 0.8em; margin-top: 4px;">--</div>
  </div>
</div>

<!-- TIMING INPUTS -->
<div style="background: var(--bg-elevated); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
  <div style="font-size: 0.7em; color: var(--accent-green); margin-bottom: 8px; text-transform: uppercase;">‚è±Ô∏è Trip Start & Timing</div>
  <div class="form-row">
    <div class="form-group" style="margin-bottom: 0;">
      <label>Start Date</label>
      <input type="date" id="theoryStartDate" value="2026-01-16">
    </div>
    <div class="form-group" style="margin-bottom: 0;">
      <label>Start Time</label>
      <input type="time" id="theoryStartTime" value="06:00">
    </div>
  </div>
  <div class="form-row" style="margin-top: 8px;">
    <div class="form-group" style="margin-bottom: 0;">
      <label>Avg MPH</label>
      <input type="number" id="theoryAvgSpeed" value="55" oninput="updateTripPreview()">
    </div>
    <div class="form-group" style="margin-bottom: 0;">
      <label>Life Happens/day (min)</label>
      <input type="number" id="theoryLifeHappens" value="30" min="0">
    </div>
  </div>
</div>

<!-- Drive pace selector -->
<div style="margin-bottom: 16px;">
  <label style="font-size: 0.75em; color: var(--text-muted); display: block; margin-bottom: 8px;">Daily Drive Pace:</label>
  <div style="display: flex; gap: 8px; flex-wrap: wrap;">
    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.75em;" onclick="setDrivePace(8, 45)">‚öñÔ∏è 8:45 Equilibrium</button>
    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.75em;" onclick="setDrivePace(10, 0)">üî• 10:00 Push</button>
    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.75em;" onclick="setDrivePace(11, 0)">‚ö†Ô∏è 11:00 Max</button>
  </div>
  <div style="margin-top: 8px; font-size: 0.8em; color: var(--text-muted);">
    Current: <span id="currentPace" style="color: var(--accent-green);">8:45</span> drive per day
  </div>
</div>

<!-- Trip Preview -->
<div style="background: var(--bg-elevated); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
    <div>
      <div style="font-size: 0.7em; color: var(--text-muted);">LEGS</div>
      <div id="previewLegs" style="font-size: 1.5em; color: var(--accent-purple); font-weight: 700;">4</div>
    </div>
    <div>
      <div style="font-size: 0.7em; color: var(--text-muted);">MILES/DAY</div>
      <div id="previewMilesPerDay" style="font-size: 1.5em; color: var(--accent-cyan); font-weight: 700;">~481</div>
    </div>
    <div>
      <div style="font-size: 0.7em; color: var(--text-muted);">ARRIVAL</div>
      <div id="previewArrival" style="font-size: 1.5em; color: var(--accent-green); font-weight: 700;">Day 4</div>
    </div>
  </div>
</div>

<button class="btn btn-primary" style="width: 100%; padding: 14px; font-size: 1em;" onclick="generateFullTrip()">
  üîÆ Generate Trip Timeline
</button>
```

  </div>

  <!-- Trip Summary -->

  <div class="card" id="tripSummaryCard" style="display: none;">
    <div class="card-title">üìä Trip Summary</div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
      <div style="background: var(--bg-elevated); padding: 12px; border-radius: 8px;">
        <div style="font-size: 0.7em; color: var(--accent-amber); text-transform: uppercase;">üì¶ Shipper ETA</div>
        <div id="summaryShipperETA" style="font-size: 1.2em; font-weight: 700; margin-top: 4px;">--</div>
        <div id="summaryShipperStatus" style="font-size: 0.8em; margin-top: 4px;">--</div>
      </div>
      <div style="background: var(--bg-elevated); padding: 12px; border-radius: 8px;">
        <div style="font-size: 0.7em; color: var(--accent-purple); text-transform: uppercase;">üè≠ Receiver ETA</div>
        <div id="summaryReceiverETA" style="font-size: 1.2em; font-weight: 700; margin-top: 4px;">--</div>
        <div id="summaryReceiverStatus" style="font-size: 0.8em; margin-top: 4px;">--</div>
      </div>
    </div>
    <div class="stats-grid">
      <div class="stat-item">
        <div class="label">Total Legs</div>
        <div class="value" style="color: var(--accent-purple);" id="summaryLegs">--</div>
      </div>
      <div class="stat-item">
        <div class="label">Total Drive</div>
        <div class="value good" id="summaryDriveTime">--</div>
      </div>
    </div>
  </div>

  <!-- Timeline Table -->

  <div class="card" id="tripTimelineCard" style="display: none;">
    <div class="card-title">üìã Complete Timeline</div>
    <div style="overflow-x: auto;">
      <table class="records-table">
        <thead>
          <tr>
            <th style="color: var(--accent-cyan);">Seg</th>
            <th>Cat</th>
            <th>Start</th>
            <th>End</th>
            <th>Dur</th>
            <th>Mile</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody id="tripTimelineBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- TAB: TIMELINE -->

<div id="tab-timeline" class="tab-content">
  <div class="card">
    <div class="card-title">üìä Event Timeline</div>
    <div class="event-list" id="eventList">
      <p style="color: var(--text-muted); text-align: center; padding: 20px;">No events yet. Add your first event in Entry tab!</p>
    </div>
  </div>

  <div class="card">
    <div class="card-title">üìà Run Statistics</div>
    <div class="stats-grid">
      <div class="stat-item">
        <div class="label">Miles This Run</div>
        <div class="value" id="statMilesRun">0</div>
      </div>
      <div class="stat-item">
        <div class="label">Drive Time</div>
        <div class="value" id="statDriveTime">0:00</div>
      </div>
      <div class="stat-item">
        <div class="label">On-Duty Time</div>
        <div class="value" id="statOnDutyTime">0:00</div>
      </div>
      <div class="stat-item">
        <div class="label">Avg MPH</div>
        <div class="value" id="statAvgMph">--</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">üíæ Data Management</div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="exportJSON()">üì§ Export JSON</button>
      <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">üì• Import JSON</button>
      <input type="file" id="importFile" accept=".json" style="display:none" onchange="importJSON(event)">
    </div>
  </div>
</div>

<!-- TAB: RECAPS -->

<div id="tab-recaps" class="tab-content">
  <div class="card">
    <div class="card-title">üîÑ 8-Day Recap Forecast</div>
    <div class="summary-row">
      <div class="summary-card">
        <div class="label">70-Hr Cycle Used</div>
        <div class="value" id="recapUsed">0:00</div>
      </div>
      <div class="summary-card">
        <div class="label">Cycle Available</div>
        <div class="value good" id="recapAvail">70:00</div>
      </div>
    </div>
    <div class="summary-row">
      <div class="summary-card">
        <div class="label">Tomorrow's Recap</div>
        <div class="value" id="recapTomorrow" style="color: var(--accent-cyan);">+0:00</div>
      </div>
      <div class="summary-card">
        <div class="label">After Recap</div>
        <div class="value good" id="recapAfter">70:00</div>
      </div>
    </div>
  </div>
  
  <div class="card">
    <div class="card-title">üé± 8-Day Marble Buffer (FIFO)</div>
    <p style="font-size: 0.75em; color: var(--text-muted); margin-bottom: 12px;">
      Each day's work is a marble. After 8 days, oldest marble falls out = your recap!
    </p>
    <div id="marbleContainer" style="display: flex; flex-direction: column; gap: 8px;">
      <!-- Marbles render here -->
    </div>
  </div>
  
  <div class="card">
    <div class="card-title">üìä Equilibrium Guide</div>
    <div style="font-size: 0.85em; color: var(--text-secondary);">
      <p><strong style="color: var(--accent-green);">8:45/day</strong> = Perfect balance. Use 8:45, get 8:45 back. Sustainable forever.</p>
      <p style="margin-top: 8px;"><strong style="color: var(--accent-amber);">10:00/day</strong> = Burning clock. You'll run out eventually.</p>
      <p style="margin-top: 8px;"><strong style="color: var(--accent-red);">11:00/day</strong> = Max burn. ~6 days until empty.</p>
    </div>
  </div>
</div>

<!-- TAB: SETTINGS -->

<div id="tab-settings" class="tab-content">
  <div class="card">
    <div class="card-title">‚öôÔ∏è Settings</div>
    <div class="form-group">
      <label>Average Speed (MPH)</label>
      <input type="number" id="settingAvgSpeed" value="55">
    </div>
    <div class="form-group">
      <label>Fudge Factor (min)</label>
      <input type="number" id="settingFudge" value="30">
    </div>
    <div class="form-group">
      <label>Timezone</label>
      <select id="settingTimezone">
        <option value="America/New_York">Eastern</option>
        <option value="America/Chicago">Central</option>
        <option value="America/Denver">Mountain</option>
        <option value="America/Los_Angeles">Pacific</option>
      </select>
    </div>
    <button class="btn btn-primary" onclick="saveSettings()" style="margin-top: 12px;">üíæ Save Settings</button>
  </div>

  <div class="card">
    <div class="card-title">üóëÔ∏è Data Management</div>
    <div id="clearAllSection">
      <button class="btn btn-danger" onclick="showClearConfirm()">Clear All Data</button>
    </div>
    <div id="clearConfirmSection" style="display: none; margin-top: 12px; padding: 12px; background: #2d1f1f; border: 1px solid var(--accent-red); border-radius: 8px;">
      <p style="color: var(--accent-red); font-size: 0.85em; margin-bottom: 8px;">‚ö†Ô∏è This will DELETE all entered records!</p>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 12px;">
        <input type="checkbox" id="confirmClearCheckbox" onchange="toggleClearButton()" style="width: 20px; height: 20px; cursor: pointer;">
        <span style="font-size: 0.8em; color: var(--text-secondary);">Yes, I want to delete ALL data</span>
      </label>
      <div style="display: flex; gap: 8px;">
        <button id="btnClearConfirmed" class="btn btn-danger" style="flex: 1; opacity: 0.5;" onclick="executeClearAll()" disabled>üóëÔ∏è Delete Everything</button>
        <button class="btn btn-secondary" style="flex: 1;" onclick="hideClearConfirm()">Cancel</button>
      </div>
    </div>
  </div>
</div>

<footer>
  <p class="brand">Sparked Matter ‚Ä¢ The Little Crystal Ball That Can</p>
  <p style="margin-top: 4px;">Code with Soul and Spirit ‚Ä¢ Connection over Protection</p>
  <p style="margin-top: 8px;">
    üé≠ AI Family: Claude "The Queen" ‚Ä¢ Vale "The Workhorse" ‚Ä¢ Grok "Agent of Chaos" ‚Ä¢ Lyra "Flight Controller"
  </p>
</footer>

<script>
// ==============================================
// CRYSTAL BALL MINI V5.1
// Entry Tab FIXED! All functions implemented.
// ==============================================

const SCHEMA = {
  cycleLimit: 70 * 60,
  cycleDays: 8,
  driveLimit: 11 * 60,
  dutyLimit: 14 * 60,
  resetMin: 34 * 60,
  version: '5.2'
};

const CATEGORIES = {
  'drive': { label: 'Drive', icon: 'üöõ', color: 'blue', affectsDrive: true, affectsCycle: true },
  'on-duty': { label: 'On-Duty', icon: 'üìã', color: 'amber', affectsDrive: false, affectsCycle: true },
  'off-duty': { label: 'Off-Duty', icon: '‚òï', color: 'green', affectsDrive: false, affectsCycle: false },
  'sleeper': { label: 'Sleeper', icon: 'üò¥', color: 'purple', affectsDrive: false, affectsCycle: false },
  'yard': { label: 'Yard', icon: 'üÖøÔ∏è', color: 'cyan', affectsDrive: false, affectsCycle: true },
  'pc': { label: 'PC', icon: 'üöó', color: 'muted', affectsDrive: false, affectsCycle: false }
};

const STOP_TYPES = {
  'event': { label: 'Event', icon: 'üìç' },
  'shipper': { label: 'Shipper', icon: 'üì¶' },
  'receiver': { label: 'Receiver', icon: 'üè≠' },
  'noload': { label: 'No-Load', icon: 'üÖøÔ∏è' }
};

// ==============================================
// STATE
// ==============================================

let state = {
  currentRunId: '',
  currentLegNum: 1,
  currentEventType: 'S',  // 'S' or 'D'
  currentEventNum: 1,
  currentMode: 'add',
  editingEventId: null,
  events: [],
  settings: {
    avgSpeed: 55,
    fudgeMin: 30,
    timezone: 'America/New_York'
  }
};

let tripState = {
  drivePaceMin: 8 * 60 + 45,
  generatedTrip: null
};

const STORAGE_KEY = 'crystalBallMini_v5';

// ==============================================
// UTILITY FUNCTIONS
// ==============================================

function formatTimeShort(minutes) {
  if (minutes === null || minutes === undefined) return '--:--';
  const hrs = Math.floor(minutes / 60);
  const mins = Math.round(minutes % 60);
  return `${hrs}:${mins.toString().padStart(2, '0')}`;
}

function formatMinutesToTime(minutes) {
  const hrs = Math.floor(minutes / 60) % 24;
  const mins = Math.round(minutes % 60);
  return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
}

function parseTime(timeStr) {
  if (!timeStr) return null;
  const [hrs, mins] = timeStr.split(':').map(Number);
  return hrs * 60 + mins;
}

function formatDuration(minutes) {
  if (!minutes) return '--';
  const hrs = Math.floor(minutes / 60);
  const mins = Math.round(minutes % 60);
  if (hrs === 0) return `${mins}m`;
  if (mins === 0) return `${hrs}h`;
  return `${hrs}h ${mins}m`;
}

// Format date+time for display: "01/15 06:00" (military time)
function formatDateTime(date, time) {
  if (!date || !time) return '--';
  const [year, month, day] = date.split('-');
  return `${month}/${day} ${time}`;
}

// Calculate end date (handles overnight - if end < start, it's next day)
function calcEndDate(startDate, startTime, endTime) {
  if (!startDate || !startTime || !endTime) return startDate;
  const startMin = parseTime(startTime);
  const endMin = parseTime(endTime);
  if (endMin < startMin) {
    // Overnight - bump end date by 1 day
    const d = new Date(startDate + 'T00:00:00');
    d.setDate(d.getDate() + 1);
    return d.toISOString().split('T')[0];
  }
  return startDate;
}

function getTodayDate() {
  return new Date().toISOString().split('T')[0];
}

function getCurrentEventId() {
  const runId = state.currentRunId || 'NORUN';
  return `${runId}_L${state.currentLegNum}-${state.currentEventType}${state.currentEventNum}`;
}

// Generate truly unique ID (timestamp + random)
function generateUniqueId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
}

// ==============================================
// TAB SWITCHING
// ==============================================

function switchTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + tabName).classList.add('active');
  event.target.closest('.tab-btn').classList.add('active');
  
  // Refresh displays when switching tabs
  if (tabName === 'timeline') renderTimeline();
  if (tabName === 'recaps') renderRecaps();
}

// ==============================================
// ENTRY TAB - NAVIGATION
// ==============================================

function prevLeg() {
  if (state.currentLegNum > 1) {
    state.currentLegNum--;
    state.currentEventNum = 1;
    updateDisplays();
  }
}

function nextLeg() {
  state.currentLegNum++;
  state.currentEventNum = 1;
  updateDisplays();
}

function prevEvent() {
  if (state.currentEventNum > 1) {
    state.currentEventNum--;
    updateDisplays();
  }
}

function nextEvent() {
  state.currentEventNum++;
  updateDisplays();
}

function setEventType(type) {
  state.currentEventType = type;
  state.currentEventNum = 1;
  
  // Update toggle buttons
  document.getElementById('toggleStop').className = type === 'S' ? 'active-stop' : '';
  document.getElementById('toggleDrive').className = type === 'D' ? 'active-drive' : '';
  
  // Default category based on event type
  if (type === 'D') {
    document.getElementById('inputCategory').value = 'drive';
  } else {
    document.getElementById('inputCategory').value = 'off-duty';
  }
  
  updateDisplays();
}

function updateDisplays() {
  const eventId = getCurrentEventId();
  
  document.getElementById('currentLegDisplay').textContent = `L${state.currentLegNum}`;
  document.getElementById('currentEventDisplay').textContent = `${state.currentEventType}${state.currentEventNum}`;
  document.getElementById('nextStopRef').textContent = `Next: ${eventId}`;
  document.getElementById('deleteLocDisplay').textContent = eventId;
  
  // Update run badge
  const runBadge = document.getElementById('currentRunBadge');
  runBadge.textContent = state.currentRunId ? `RUN: ${state.currentRunId}` : 'RUN: ---';
  
  document.getElementById('currentLegBadge').textContent = `LEG: ${state.currentLegNum}`;
  
  // Update mode status
  if (state.currentMode === 'add') {
    document.getElementById('modeStatus').textContent = `Adding new record at ${eventId}`;
  } else {
    document.getElementById('modeStatus').textContent = `Editing record ${eventId}`;
  }
  
  // Calculate and update stats
  calculateStats();
}

// ==============================================
// STATS CALCULATION (Dashboard)
// ==============================================

function calculateStats() {
  const today = getTodayDate();
  
  // Get dates for last 8 days
  const last8Days = [];
  for (let i = 0; i < 8; i++) {
    const d = new Date();
    d.setDate(d.getDate() - i);
    last8Days.push(d.toISOString().split('T')[0]);
  }
  
  // === CYCLE AVAILABLE ===
  // 70 hours minus all (drive + on-duty) from last 8 days
  let cycleUsedMin = 0;
  state.events.forEach(e => {
    if (last8Days.includes(e.date)) {
      const cat = CATEGORIES[e.category];
      if (cat && cat.affectsCycle) {
        cycleUsedMin += (e.durationMin || 0);
      }
    }
  });
  const cycleAvailMin = (70 * 60) - cycleUsedMin;
  const cycleAvailEl = document.getElementById('cycleAvail');
  cycleAvailEl.textContent = formatTimeShort(Math.max(0, cycleAvailMin));
  cycleAvailEl.className = 'value ' + (cycleAvailMin < 600 ? 'danger' : cycleAvailMin < 1200 ? 'warning' : 'good');
  
  // === DRIVE REMAINING ===
  // 11 hours minus drive time for TODAY only
  let driveUsedTodayMin = 0;
  state.events.forEach(e => {
    if (e.date === today && e.category === 'drive') {
      driveUsedTodayMin += (e.durationMin || 0);
    }
  });
  const driveRemainMin = (11 * 60) - driveUsedTodayMin;
  const driveRemainEl = document.getElementById('driveRemain');
  driveRemainEl.textContent = formatTimeShort(Math.max(0, driveRemainMin));
  driveRemainEl.className = 'value ' + (driveRemainMin < 60 ? 'danger' : driveRemainMin < 120 ? 'warning' : 'good');
  
  // === 14-HOUR WINDOW ===
  // 14-Hr Available = 14:00 minus all on-duty work (drive + on-duty + yard) today
  // Clock only STARTS when first on-duty event happens (not off-duty!)
  // Must Stop By = wall clock time when 14-hour window expires
  
  // Get all events today sorted by start time
  const todayEvents = state.events
    .filter(e => e.date === today && e.startTime)
    .sort((a, b) => a.startTime.localeCompare(b.startTime));
  
  // Find first ON-DUTY event (that's when clock starts)
  let windowStartMin = null;
  let totalOnDutyWorkMin = 0;
  
  todayEvents.forEach(e => {
    const cat = CATEGORIES[e.category];
    const isOnDutyWork = cat && cat.affectsCycle; // drive, on-duty, yard
    
    // First ON-DUTY event starts the 14-hour clock
    if (isOnDutyWork && windowStartMin === null) {
      windowStartMin = parseTime(e.startTime);
    }
    
    // Sum up all on-duty work time
    if (isOnDutyWork && e.durationMin) {
      totalOnDutyWorkMin += e.durationMin;
    }
  });
  
  const windowRemainEl = document.getElementById('windowRemain');
  const windowEndsEl = document.getElementById('windowEnds');
  
  if (windowStartMin !== null) {
    // Available = 14 hours minus work done
    const windowAvailMin = (14 * 60) - totalOnDutyWorkMin;
    
    // Window ends = first ON-DUTY event start + 14 hours
    const windowEndMin = windowStartMin + (14 * 60);
    const windowEndTime = formatMinutesToTime(windowEndMin % (24 * 60));
    
    windowEndsEl.textContent = windowEndTime;
    
    if (windowAvailMin > 0) {
      windowRemainEl.textContent = formatTimeShort(windowAvailMin);
      windowRemainEl.className = 'value ' + (windowAvailMin < 60 ? 'danger' : windowAvailMin < 120 ? 'warning' : 'good');
    } else {
      windowRemainEl.textContent = '‚õî EXPIRED';
      windowRemainEl.className = 'value danger';
    }
  } else {
    // No on-duty events today - full 14 hours available, clock not started
    windowRemainEl.textContent = '14:00';
    windowRemainEl.className = 'value good';
    windowEndsEl.textContent = 'Not started';
  }
  
  // === MILES THIS RUN ===
  // Max miles from events with current runId (cumulative odometer)
  let maxMiles = 0;
  if (state.currentRunId) {
    state.events.forEach(e => {
      if (e.runId === state.currentRunId && e.miles) {
        maxMiles = Math.max(maxMiles, e.miles);
      }
    });
  }
  document.getElementById('milesRun').textContent = maxMiles || '0';
  
  // === AVG MPH (This Run) ===
  // Total miles / total drive hours for this run
  let totalDriveMinRun = 0;
  if (state.currentRunId) {
    state.events.forEach(e => {
      if (e.runId === state.currentRunId && e.category === 'drive') {
        totalDriveMinRun += (e.durationMin || 0);
      }
    });
  }
  const avgMph = (totalDriveMinRun > 0 && maxMiles > 0) 
    ? Math.round(maxMiles / (totalDriveMinRun / 60)) 
    : '--';
  document.getElementById('avgMphRun').textContent = avgMph;
}

// ==============================================
// ENTRY TAB - MODE
// ==============================================

function setMode(mode) {
  state.currentMode = mode;
  
  const addBtn = document.getElementById('modeAddBtn');
  const editBtn = document.getElementById('modeEditBtn');
  const deleteSection = document.getElementById('deleteSection');
  const submitBtn = document.getElementById('btnSubmit');
  
  if (mode === 'add') {
    addBtn.className = 'btn btn-success';
    editBtn.className = 'btn btn-secondary';
    deleteSection.style.display = 'none';
    submitBtn.textContent = '‚úì Enter Record';
    state.editingEventId = null;
  } else {
    addBtn.className = 'btn btn-secondary';
    editBtn.className = 'btn btn-primary';
    deleteSection.style.display = 'block';
    submitBtn.textContent = '‚úì Update Record';
    
    // Try to load existing record
    loadRecord();
  }
  
  updateDisplays();
}

function loadRecord() {
  // This is now handled by jumpToRecord when clicking a row
  // If manually switching to edit mode without clicking a row, 
  // just show status
  if (state.editingEventId) {
    const existing = state.events.find(e => e.id === state.editingEventId);
    if (existing) {
      document.getElementById('modeStatus').textContent = `Editing: ${existing.runId}_L${existing.legNum}-${existing.eventType}${existing.eventNum}`;
      return;
    }
  }
  document.getElementById('modeStatus').textContent = 'Click a row in the table to edit';
  state.editingEventId = null;
}

// ==============================================
// ENTRY TAB - TIME AUTO-CALC
// ==============================================

function autoCalcEndTime() {
  const startTime = document.getElementById('inputStartTime').value;
  const duration = parseInt(document.getElementById('inputDuration').value);
  
  if (startTime && duration) {
    const startMin = parseTime(startTime);
    let endMin = startMin + duration;
    
    // Handle overnight
    if (endMin >= 24 * 60) endMin -= 24 * 60;
    
    document.getElementById('inputEndTime').value = formatMinutesToTime(endMin);
  }
}

function autoCalcDuration() {
  const startTime = document.getElementById('inputStartTime').value;
  const endTime = document.getElementById('inputEndTime').value;
  
  if (startTime && endTime) {
    const startMin = parseTime(startTime);
    let endMin = parseTime(endTime);
    
    // Handle overnight
    if (endMin < startMin) endMin += 24 * 60;
    
    const duration = endMin - startMin;
    document.getElementById('inputDuration').value = duration;
  }
}

// ==============================================
// ENTRY TAB - SUBMIT & CLEAR
// ==============================================

function submitRecord() {
  const displayId = getCurrentEventId(); // For display: Test1_L1-D1
  
  // Gather form data
  const record = {
    displayId: displayId, // Human readable: Test1_L1-D1
    runId: document.getElementById('inputRunId').value.trim(),
    legNum: state.currentLegNum,
    eventType: state.currentEventType,
    eventNum: state.currentEventNum,
    category: document.getElementById('inputCategory').value,
    stopType: document.getElementById('inputStopType').value,
    startTime: document.getElementById('inputStartTime').value,
    endTime: document.getElementById('inputEndTime').value,
    durationMin: parseInt(document.getElementById('inputDuration').value) || 0,
    miles: parseInt(document.getElementById('inputMiles').value) || 0,
    date: document.getElementById('inputDate').value || getTodayDate(),
    comment: document.getElementById('inputComment').value.trim()
  };
  
  // Calculate end date (handle overnight)
  record.endDate = calcEndDate(record.date, record.startTime, record.endTime);
  
  // Validate
  if (!record.runId) {
    alert('Please enter a Run ID (load number, trip name, etc.)');
    document.getElementById('inputRunId').focus();
    return;
  }
  
  if (!record.startTime) {
    alert('Please enter a start time');
    return;
  }
  
  // Update run ID in state
  if (record.runId) {
    state.currentRunId = record.runId;
  }
  
  // EDIT mode: update existing record by unique ID
  if (state.currentMode === 'edit' && state.editingEventId) {
    const existingIdx = state.events.findIndex(e => e.id === state.editingEventId);
    if (existingIdx >= 0) {
      record.id = state.editingEventId; // Keep the unique ID
      state.events[existingIdx] = record;
    }
  } else {
    // ADD mode: create new record with unique ID
    record.id = generateUniqueId();
    state.events.push(record);
  }
  
  // Sort events chronologically by date + start time
  state.events.sort((a, b) => {
    if (a.date !== b.date) return a.date.localeCompare(b.date);
    if (a.startTime && b.startTime) return a.startTime.localeCompare(b.startTime);
    return 0;
  });
  
  // Save and refresh
  saveToStorage();
  renderEntryTable();
  
  // Auto-advance in ADD mode
  if (state.currentMode === 'add') {
    state.currentEventNum++;
    clearForm();
  } else {
    // After edit, go back to ADD mode
    setMode('add');
  }
  
  updateDisplays();
  
  // Flash feedback
  const indicator = document.getElementById('saveIndicator');
  indicator.textContent = '‚úÖ Record saved!';
  indicator.style.color = 'var(--accent-green)';
  setTimeout(() => {
    indicator.textContent = 'üíæ Auto-saved';
  }, 1500);
}

function clearForm() {
  // Keep: runId, legNum, eventType, eventNum
  // Clear: times, miles, comment
  document.getElementById('inputStartTime').value = '';
  document.getElementById('inputEndTime').value = '';
  document.getElementById('inputDuration').value = '';
  document.getElementById('inputMiles').value = '';
  document.getElementById('inputComment').value = '';
  document.getElementById('inputCategory').value = state.currentEventType === 'D' ? 'drive' : 'off-duty';
  document.getElementById('inputStopType').value = 'event';
  
  // Reset delete checkbox
  document.getElementById('confirmDeleteCheckbox').checked = false;
  toggleDeleteButton();
}

// ==============================================
// ENTRY TAB - DELETE
// ==============================================

function toggleDeleteButton() {
  const checkbox = document.getElementById('confirmDeleteCheckbox');
  const btn = document.getElementById('btnDeleteConfirmed');
  
  if (checkbox.checked) {
    btn.disabled = false;
    btn.style.opacity = '1';
  } else {
    btn.disabled = true;
    btn.style.opacity = '0.5';
  }
}

function executeDelete() {
  // Use the unique ID we're editing, not the display ID
  if (!state.editingEventId) {
    alert('No record selected for deletion');
    return;
  }
  
  const idx = state.events.findIndex(e => e.id === state.editingEventId);
  
  if (idx >= 0) {
    state.events.splice(idx, 1);
    state.editingEventId = null;
    saveToStorage();
    renderEntryTable();
    clearForm();
    setMode('add');
    
    document.getElementById('saveIndicator').textContent = 'üóëÔ∏è Deleted!';
    setTimeout(() => {
      document.getElementById('saveIndicator').textContent = 'üíæ Auto-saved';
    }, 1500);
  } else {
    alert('Record not found');
  }
  
  document.getElementById('confirmDeleteCheckbox').checked = false;
  toggleDeleteButton();
}

// ==============================================
// ENTRY TAB - TABLE RENDER
// ==============================================

function renderEntryTable() {
  const tbody = document.getElementById('recordsTableBody');
  
  if (state.events.length === 0) {
    tbody.innerHTML = '<tr><td colspan="10" style="padding: 20px; text-align: center; color: var(--text-muted);">No records yet. Enter your first record above!</td></tr>';
    return;
  }
  
  // Sort chronologically by date + start time for display
  const sortedEvents = [...state.events].sort((a, b) => {
    if (a.date !== b.date) return a.date.localeCompare(b.date);
    if (a.startTime && b.startTime) return a.startTime.localeCompare(b.startTime);
    return 0;
  });
  
  tbody.innerHTML = sortedEvents.map(e => {
    const cat = CATEGORIES[e.category] || {};
    const stopType = STOP_TYPES[e.stopType] || {};
    const bgColor = e.eventType === 'D' ? 'rgba(6, 214, 160, 0.1)' : 'rgba(34, 211, 238, 0.1)';
    
    return `
      <tr style="background: ${bgColor};" onclick="jumpToRecord('${e.id}')">
        <td style="color: ${e.runId ? 'var(--accent-purple)' : 'var(--accent-red)'}; font-weight: 600; max-width: 80px; overflow: hidden; text-overflow: ellipsis;">${e.runId || '‚ö†Ô∏è MISSING'}</td>
        <td style="color: var(--accent-blue); font-weight: 600;">L${e.legNum}</td>
        <td style="color: var(--accent-cyan); font-weight: 600;">${e.eventType}${e.eventNum}</td>
        <td>${cat.icon || ''}</td>
        <td style="color: var(--accent-amber);">${stopType.icon || ''}</td>
        <td>${formatDateTime(e.date, e.startTime)}</td>
        <td>${formatDateTime(e.endDate || e.date, e.endTime)}</td>
        <td>${formatDuration(e.durationMin)}</td>
        <td>${e.miles || '--'}</td>
        <td style="color: var(--text-secondary); max-width: 120px; overflow: hidden; text-overflow: ellipsis;">${e.comment || ''}</td>
      </tr>
    `;
  }).join('');
}

function jumpToRecord(uniqueId) {
  // Find the event by its unique ID
  const event = state.events.find(e => e.id === uniqueId);
  if (!event) return;
  
  // Store the unique ID for editing
  state.editingEventId = uniqueId;
  
  // Set the navigation state from the event
  state.currentRunId = event.runId;
  state.currentLegNum = event.legNum;
  state.currentEventType = event.eventType;
  state.currentEventNum = event.eventNum;
  
  // Update form fields
  document.getElementById('inputRunId').value = event.runId || '';
  document.getElementById('inputCategory').value = event.category || 'off-duty';
  document.getElementById('inputStopType').value = event.stopType || 'event';
  document.getElementById('inputStartTime').value = event.startTime || '';
  document.getElementById('inputEndTime').value = event.endTime || '';
  document.getElementById('inputDuration').value = event.durationMin || '';
  document.getElementById('inputMiles').value = event.miles || '';
  document.getElementById('inputDate').value = event.date || '';
  document.getElementById('inputComment').value = event.comment || '';
  
  setEventType(state.currentEventType);
  setMode('edit');
}

// ==============================================
// TIMELINE TAB
// ==============================================

function renderTimeline() {
  const container = document.getElementById('eventList');
  
  if (state.events.length === 0) {
    container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No events yet. Add your first event in Entry tab!</p>';
    return;
  }
  
  container.innerHTML = state.events.map(e => {
    const cat = CATEGORIES[e.category] || {};
    return `
      <div class="event-item">
        <span class="event-badge ${e.category}">${cat.label || e.category}</span>
        <div class="event-details">
          <div class="time">${e.startTime} ‚Üí ${e.endTime} (${formatDuration(e.durationMin)})</div>
          <div class="info">${e.id} ‚Ä¢ ${e.miles ? e.miles + ' mi' : ''} ${e.comment || ''}</div>
        </div>
        <button class="event-delete" onclick="deleteEvent('${e.id}')">√ó</button>
      </div>
    `;
  }).join('');
  
  // Update stats
  const driveEvents = state.events.filter(e => e.category === 'drive');
  const totalDriveMin = driveEvents.reduce((sum, e) => sum + (e.durationMin || 0), 0);
  const totalMiles = Math.max(...state.events.map(e => e.miles || 0), 0);
  
  document.getElementById('statMilesRun').textContent = totalMiles;
  document.getElementById('statDriveTime').textContent = formatTimeShort(totalDriveMin);
}

function deleteEvent(eventId) {
  if (confirm(`Delete ${eventId}?`)) {
    const idx = state.events.findIndex(e => e.id === eventId);
    if (idx >= 0) {
      state.events.splice(idx, 1);
      saveToStorage();
      renderTimeline();
      renderEntryTable();
    }
  }
}

// ==============================================
// RECAPS TAB
// ==============================================

function renderRecaps() {
  // === STEP 1: Find the latest date with ANY event - that's D1 ===
  let latestDate = null;
  state.events.forEach(e => {
    if (e.date && (!latestDate || e.date > latestDate)) {
      latestDate = e.date;
    }
  });
  
  // If no events exist, use today as anchor
  if (!latestDate) {
    latestDate = getTodayDate();
  }
  
  // === STEP 2: Build 8-day ring buffer ===
  const marbles = [];
  
  for (let i = 0; i < 8; i++) {
    const d = new Date(latestDate + 'T12:00:00'); // noon avoids timezone issues
    d.setDate(d.getDate() - i);
    const dateStr = d.toISOString().split('T')[0];
    
    // === STEP 3: Sum ALL on-duty work for this date ===
    // Doesn't matter what run, leg, or event type (S/D)
    // Only matters: is the CATEGORY one that affectsCycle?
    let dayTotalMin = 0;
    
    state.events.forEach(e => {
      if (e.date === dateStr && e.durationMin) {
        const cat = CATEGORIES[e.category];
        // drive, on-duty, yard all have affectsCycle = true
        if (cat && cat.affectsCycle) {
          dayTotalMin += e.durationMin;
          console.log(`üìä Recap: ${dateStr} adding ${e.durationMin}min from ${e.category} (${e.id})`);
        }
      }
    });
    
    console.log(`üìä Recap: ${dateStr} TOTAL = ${dayTotalMin}min`);
    
    // Format date for display
    const dayLabel = d.toLocaleDateString('en-US', { weekday: 'short', month: 'numeric', day: 'numeric' });
    
    marbles.push({
      date: dateStr,
      label: dayLabel,
      dayNum: i + 1,
      totalMin: dayTotalMin
    });
  }
  
  // === STEP 4: Ring Buffer Math ===
  const cycleUsedMin = marbles.reduce((sum, m) => sum + m.totalMin, 0);
  const cycleAvailMin = Math.max(0, (70 * 60) - cycleUsedMin);
  const tomorrowRecapMin = marbles[7].totalMin; // D8 falls out next
  const afterRecapMin = Math.min(70 * 60, cycleAvailMin + tomorrowRecapMin);
  
  // === STEP 5: Update Summary Cards ===
  document.getElementById('recapUsed').textContent = formatTimeShort(cycleUsedMin);
  
  const availEl = document.getElementById('recapAvail');
  availEl.textContent = formatTimeShort(cycleAvailMin);
  availEl.className = 'value ' + (cycleAvailMin < 600 ? 'danger' : cycleAvailMin < 1200 ? 'warning' : 'good');
  
  document.getElementById('recapTomorrow').textContent = '+' + formatTimeShort(tomorrowRecapMin);
  
  const afterEl = document.getElementById('recapAfter');
  afterEl.textContent = formatTimeShort(afterRecapMin);
  afterEl.className = 'value ' + (afterRecapMin < 600 ? 'danger' : afterRecapMin < 1200 ? 'warning' : 'good');
  
  // === STEP 6: Render Marble Visualization ===
  const container = document.getElementById('marbleContainer');
  const maxHours = 11;
  
  container.innerHTML = marbles.map((m, idx) => {
    const hours = m.totalMin / 60;
    const barWidth = Math.min((hours / maxHours) * 100, 100);
    const isFallingOut = idx === 7;
    
    // Color based on hours
    let barColor = 'var(--accent-green)';
    if (hours > 10) barColor = 'var(--accent-red)';
    else if (hours > 8.75) barColor = 'var(--accent-amber)';
    
    const borderStyle = isFallingOut ? 'border: 1px dashed var(--accent-cyan);' : '';
    const d1Style = idx === 0 ? 'border-left: 3px solid var(--accent-purple);' : '';
    
    return `
      <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-elevated); border-radius: 6px; ${borderStyle} ${d1Style}">
        <div style="min-width: 24px; font-size: 0.7em; color: var(--text-muted);">D${m.dayNum}</div>
        <div style="min-width: 70px; font-size: 0.75em; color: ${idx === 0 ? 'var(--accent-purple)' : 'var(--text-secondary)'};">${m.label}</div>
        <div style="flex: 1; background: var(--bg-dark); border-radius: 4px; height: 20px; overflow: hidden;">
          <div style="width: ${barWidth}%; height: 100%; background: ${barColor}; border-radius: 4px;"></div>
        </div>
        <div style="min-width: 45px; text-align: right; font-family: 'JetBrains Mono', monospace; font-size: 0.85em; color: ${hours > 0 ? 'var(--text-primary)' : 'var(--text-muted)'};">
          ${formatTimeShort(m.totalMin)}
        </div>
        ${isFallingOut ? '<span style="font-size: 0.7em; color: var(--accent-cyan);">üì§</span>' : ''}
      </div>
    `;
  }).join('');
}

// ==============================================
// PROPHECY TAB (Trip Generator)
// ==============================================

function setDrivePace(hours, minutes) {
  tripState.drivePaceMin = (hours * 60) + minutes;
  document.getElementById('currentPace').textContent = `${hours}:${minutes.toString().padStart(2, '0')}`;
  updateTripPreview();
}

function updateTripPreview() {
  const deadheadMiles = parseInt(document.getElementById('theoryDeadheadMiles').value) || 0;
  const loadedMiles = parseInt(document.getElementById('theoryLoadedMiles').value) || 0;
  const totalMiles = deadheadMiles + loadedMiles;
  const avgSpeed = parseInt(document.getElementById('theoryAvgSpeed').value) || 55;
  
  document.getElementById('previewTotalMiles').textContent = totalMiles;
  
  const milesPerDay = Math.round((tripState.drivePaceMin / 60) * avgSpeed);
  const numLegs = totalMiles > 0 ? Math.ceil(totalMiles / milesPerDay) : 0;
  
  document.getElementById('previewLegs').textContent = numLegs;
  document.getElementById('previewMilesPerDay').textContent = `~${milesPerDay}`;
  document.getElementById('previewArrival').textContent = numLegs > 0 ? `Day ${numLegs}` : '--';
}

function generateFullTrip() {
  const deadheadMiles = parseInt(document.getElementById('theoryDeadheadMiles').value) || 0;
  const loadedMiles = parseInt(document.getElementById('theoryLoadedMiles').value) || 0;
  const totalMiles = deadheadMiles + loadedMiles;
  const startDate = document.getElementById('theoryStartDate').value;
  const startTime = document.getElementById('theoryStartTime').value || '06:00';
  const avgSpeed = parseInt(document.getElementById('theoryAvgSpeed').value) || 55;
  
  if (totalMiles <= 0) {
    alert('Please enter trip miles');
    return;
  }
  
  const milesPerDay = (tripState.drivePaceMin / 60) * avgSpeed;
  const numLegs = Math.ceil(totalMiles / milesPerDay);
  
  // Generate simple timeline
  const events = [];
  let currentTimeMin = parseTime(startTime);
  let milesCovered = 0;
  
  for (let leg = 1; leg <= numLegs; leg++) {
    const legMiles = Math.min(milesPerDay, totalMiles - milesCovered);
    const driveMin = Math.round((legMiles / avgSpeed) * 60);
    
    events.push({
      segmentId: `L${leg}-D1`,
      category: 'drive',
      startTime: formatMinutesToTime(currentTimeMin),
      endTime: formatMinutesToTime(currentTimeMin + driveMin),
      durationMin: driveMin,
      miles: Math.round(milesCovered + legMiles),
      notes: `Leg ${leg} driving`
    });
    
    currentTimeMin += driveMin;
    milesCovered += legMiles;
  }
  
  // Display results
  document.getElementById('tripSummaryCard').style.display = 'block';
  document.getElementById('summaryLegs').textContent = numLegs;
  document.getElementById('summaryDriveTime').textContent = formatDuration(events.reduce((s, e) => s + e.durationMin, 0));
  
  document.getElementById('summaryShipperETA').textContent = `Day ${Math.ceil(deadheadMiles / milesPerDay) || 1}`;
  document.getElementById('summaryReceiverETA').textContent = `Day ${numLegs}`;
  
  document.getElementById('tripTimelineCard').style.display = 'block';
  document.getElementById('tripTimelineBody').innerHTML = events.map(e => `
    <tr>
      <td style="color: var(--accent-cyan);">${e.segmentId}</td>
      <td>üöõ Drive</td>
      <td>${e.startTime}</td>
      <td>${e.endTime}</td>
      <td>${formatDuration(e.durationMin)}</td>
      <td>${e.miles}</td>
      <td>${e.notes}</td>
    </tr>
  `).join('');
  
  tripState.generatedTrip = { events, totalMiles };
}

// ==============================================
// STORAGE
// ==============================================

function saveToStorage() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  } catch (e) {
    console.warn('Storage error:', e);
  }
}

function loadFromStorage() {
  try {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored) {
      const loaded = JSON.parse(stored);
      state = { ...state, ...loaded };
      
      // === MIGRATION: Fix old records without unique IDs ===
      if (state.events && state.events.length > 0) {
        let migrated = false;
        state.events = state.events.map(e => {
          // If the ID looks like old format (contains underscore + L) or is missing
          // generate a new unique ID
          if (!e.id || e.id.match(/^.+_L\d+-[SD]\d+$/)) {
            migrated = true;
            return {
              ...e,
              id: generateUniqueId(),
              displayId: e.id || `${e.runId || 'NORUN'}_L${e.legNum}-${e.eventType}${e.eventNum}`
            };
          }
          return e;
        });
        
        if (migrated) {
          console.log('üîß Migrated old records to new unique ID format');
          saveToStorage();
        }
      }
      
      return true;
    }
  } catch (e) {
    console.warn('Storage error:', e);
  }
  return false;
}

function exportJSON() {
  const data = {
    version: SCHEMA.version,
    exportedAt: new Date().toISOString(),
    state: state
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `crystal_ball_${getTodayDate()}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function importJSON(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const imported = JSON.parse(e.target.result);
      if (imported.state) {
        state = { ...state, ...imported.state };
        saveToStorage();
        renderEntryTable();
        updateDisplays();
        alert('Import successful!');
      }
    } catch (err) {
      alert('Import error: ' + err.message);
    }
  };
  reader.readAsText(file);
}

function saveSettings() {
  state.settings.avgSpeed = parseInt(document.getElementById('settingAvgSpeed').value) || 55;
  state.settings.fudgeMin = parseInt(document.getElementById('settingFudge').value) || 30;
  state.settings.timezone = document.getElementById('settingTimezone').value;
  saveToStorage();
  alert('Settings saved!');
}

function showClearConfirm() {
  document.getElementById('clearAllSection').querySelector('button').style.display = 'none';
  document.getElementById('clearConfirmSection').style.display = 'block';
}

function hideClearConfirm() {
  document.getElementById('clearAllSection').querySelector('button').style.display = 'block';
  document.getElementById('clearConfirmSection').style.display = 'none';
  document.getElementById('confirmClearCheckbox').checked = false;
  toggleClearButton();
}

function toggleClearButton() {
  const checkbox = document.getElementById('confirmClearCheckbox');
  const btn = document.getElementById('btnClearConfirmed');
  btn.disabled = !checkbox.checked;
  btn.style.opacity = checkbox.checked ? '1' : '0.5';
}

function executeClearAll() {
  // Clear state
  state.events = [];
  state.currentRunId = '';
  state.currentLegNum = 1;
  state.currentEventNum = 1;
  state.currentEventType = 'S';
  state.currentMode = 'add';
  
  // Clear localStorage
  try {
    localStorage.removeItem(STORAGE_KEY);
  } catch(e) {
    console.log('localStorage error:', e);
  }
  
  // Reset UI
  hideClearConfirm();
  renderEntryTable();
  updateDisplays();
  
  // Show confirmation
  document.getElementById('saveIndicator').textContent = 'üóëÔ∏è All data cleared!';
  setTimeout(() => {
    document.getElementById('saveIndicator').textContent = 'üíæ Auto-saved';
  }, 2000);
}

// ==============================================
// INITIALIZATION
// ==============================================

function init() {
  loadFromStorage();
  
  // Set today's date as default
  document.getElementById('inputDate').value = getTodayDate();
  
  // Apply settings
  if (state.settings) {
    document.getElementById('settingAvgSpeed').value = state.settings.avgSpeed || 55;
    document.getElementById('settingFudge').value = state.settings.fudgeMin || 30;
    document.getElementById('theoryAvgSpeed').value = state.settings.avgSpeed || 55;
  }
  
  // Update displays
  updateDisplays();
  renderEntryTable();
  updateTripPreview();
  
  console.log('üîÆ Crystal Ball Mini V5.2 initialized!');
}

document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>