<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Crystal Ball Mini V5</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap');

```
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

:root {
  --bg-deep: #0a0a14;
  --bg-dark: #12121f;
  --bg-card: #1a1a2e;
  --bg-elevated: #242442;
  --accent-purple: #9d4edd;
  --accent-blue: #3a86ff;
  --accent-green: #06d6a0;
  --accent-amber: #f59e0b;
  --accent-red: #ef4444;
  --accent-cyan: #22d3ee;
  --text-primary: #f0f0f5;
  --text-secondary: #888899;
  --text-muted: #555566;
  --border: #2a2a45;
}

body {
  font-family: 'Space Grotesk', -apple-system, sans-serif;
  background: var(--bg-deep);
  color: var(--text-primary);
  min-height: 100vh;
  padding: 12px;
  padding-bottom: 100px;
}

/* === HEADER === */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0 16px 0;
}
.logo {
  display: flex;
  align-items: center;
  gap: 8px;
}
.logo-icon { font-size: 1.8em; }
.logo-text h1 {
  font-size: 1.2em;
  font-weight: 700;
  color: var(--accent-purple);
  letter-spacing: -0.5px;
}
.logo-text .version {
  font-size: 0.65em;
  color: var(--text-muted);
  font-family: 'JetBrains Mono', monospace;
}
.save-indicator {
  font-size: 0.7em;
  color: var(--accent-green);
  font-family: 'JetBrains Mono', monospace;
}

/* === TAB BAR === */
.tab-bar {
  display: flex;
  gap: 4px;
  background: var(--bg-dark);
  padding: 4px;
  border-radius: 12px;
  margin-bottom: 16px;
}
.tab-btn {
  flex: 1;
  padding: 10px 8px;
  background: transparent;
  border: none;
  border-radius: 8px;
  color: var(--text-secondary);
  font-family: inherit;
  font-size: 0.75em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}
.tab-btn .icon { font-size: 1.3em; }
.tab-btn.active {
  background: var(--bg-elevated);
  color: var(--accent-purple);
}

/* === CARDS === */
.card {
  background: var(--bg-card);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  border: 1px solid var(--border);
}
.card-title {
  font-size: 0.75em;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 12px;
}

/* === SUMMARY CARDS === */
.summary-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 12px;
}
.summary-card {
  background: var(--bg-elevated);
  border-radius: 10px;
  padding: 12px;
  text-align: center;
}
.summary-card .label {
  font-size: 0.65em;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.summary-card .value {
  font-size: 1.5em;
  font-weight: 700;
  font-family: 'JetBrains Mono', monospace;
  margin-top: 4px;
}
.summary-card .value.good { color: var(--accent-green); }
.summary-card .value.warning { color: var(--accent-amber); }
.summary-card .value.danger { color: var(--accent-red); }

/* === FORM ELEMENTS === */
.form-group {
  margin-bottom: 12px;
}
.form-group label {
  display: block;
  font-size: 0.75em;
  color: var(--text-secondary);
  margin-bottom: 4px;
}
input, select {
  width: 100%;
  padding: 10px 12px;
  background: var(--bg-dark);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-primary);
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.9em;
}
input:focus, select:focus {
  outline: none;
  border-color: var(--accent-purple);
}
.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}
.form-row-3 {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 8px;
}

/* === BUTTONS === */
.btn {
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  font-family: inherit;
  font-size: 0.85em;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
.btn-primary {
  background: var(--accent-purple);
  color: white;
}
.btn-success {
  background: var(--accent-green);
  color: var(--bg-deep);
}
.btn-danger {
  background: var(--accent-red);
  color: white;
}
.btn-secondary {
  background: var(--bg-elevated);
  color: var(--text-primary);
}
.btn:hover { opacity: 0.9; transform: translateY(-1px); }
.btn-row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

/* === EVENT LIST === */
.event-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.event-item {
  background: var(--bg-elevated);
  border-radius: 8px;
  padding: 12px;
  display: grid;
  grid-template-columns: auto 1fr auto;
  gap: 12px;
  align-items: center;
}
.event-badge {
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 0.7em;
  font-weight: 600;
  text-transform: uppercase;
}
.event-badge.drive { background: var(--accent-blue); color: white; }
.event-badge.on-duty { background: var(--accent-amber); color: var(--bg-deep); }
.event-badge.off-duty { background: var(--accent-green); color: var(--bg-deep); }
.event-badge.sleeper { background: var(--accent-purple); color: white; }
.event-badge.yard { background: var(--accent-cyan); color: var(--bg-deep); }
.event-badge.pc { background: var(--text-muted); color: white; }

.event-details {
  font-size: 0.85em;
}
.event-details .time {
  font-family: 'JetBrains Mono', monospace;
  color: var(--text-primary);
}
.event-details .info {
  color: var(--text-secondary);
  font-size: 0.9em;
}
.event-delete {
  background: none;
  border: none;
  color: var(--accent-red);
  cursor: pointer;
  font-size: 1.2em;
  opacity: 0.6;
}
.event-delete:hover { opacity: 1; }

/* === RUN/LEG HIERARCHY === */
.hierarchy-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}
.run-badge {
  background: var(--accent-purple);
  color: white;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 0.8em;
  font-weight: 600;
  font-family: 'JetBrains Mono', monospace;
}
.leg-badge {
  background: var(--accent-blue);
  color: white;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 0.75em;
  font-weight: 600;
}
.stop-ref {
  font-family: 'JetBrains Mono', monospace;
  color: var(--accent-cyan);
  font-size: 0.8em;
}

/* === CALCULATED STATS === */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--border);
}
.stat-item {
  text-align: center;
}
.stat-item .label {
  font-size: 0.6em;
  color: var(--text-muted);
  text-transform: uppercase;
}
.stat-item .value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.9em;
  color: var(--accent-green);
}

/* === TAB CONTENT === */
.tab-content { display: none; }
.tab-content.active { display: block; }

/* === FOOTER === */
footer {
  text-align: center;
  padding: 20px;
  font-size: 0.7em;
  color: var(--text-muted);
}
footer .brand { color: var(--accent-purple); font-weight: 600; }

/* === MODAL === */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.8);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.modal-overlay.active { display: flex; }
.modal {
  background: var(--bg-card);
  border-radius: 16px;
  padding: 20px;
  width: 100%;
  max-width: 400px;
  max-height: 80vh;
  overflow-y: auto;
}
.modal-title {
  font-size: 1.1em;
  font-weight: 700;
  margin-bottom: 16px;
  color: var(--accent-purple);
}
```

  </style>
</head>
<body>

<!-- HEADER -->

<header class="header">
  <div class="logo">
    <span class="logo-icon">üîÆ</span>
    <div class="logo-text">
      <h1>Crystal Ball Mini</h1>
      <span class="version">V5.0 ‚Äî Total Miles Trip Generator</span>
    </div>
  </div>
  <span class="save-indicator" id="saveIndicator">üíæ Auto-saved</span>
</header>

<!-- TAB BAR -->

<nav class="tab-bar">
  <button class="tab-btn active" onclick="switchTab('entry')">
    <span class="icon">üìù</span>
    <span>Entry</span>
  </button>
  <button class="tab-btn" onclick="switchTab('theory')">
    <span class="icon">üîÆ</span>
    <span>Theory</span>
  </button>
  <button class="tab-btn" onclick="switchTab('timeline')">
    <span class="icon">üìä</span>
    <span>Timeline</span>
  </button>
  <button class="tab-btn" onclick="switchTab('recaps')">
    <span class="icon">üîÑ</span>
    <span>Recaps</span>
  </button>
  <button class="tab-btn" onclick="switchTab('settings')">
    <span class="icon">‚öôÔ∏è</span>
    <span>Settings</span>
  </button>
</nav>

<!-- TAB: ENTRY -->

<div id="tab-entry" class="tab-content active">

  <!-- Current Run/Leg Display -->

  <div class="card">
    <div class="hierarchy-header">
      <div>
        <span class="run-badge" id="currentRunBadge">RUN: ---</span>
        <span class="leg-badge" id="currentLegBadge" style="margin-left: 8px;">LEG: ---</span>
      </div>
      <span class="stop-ref" id="nextStopRef">Next: L1-S1</span>
    </div>

```
<!-- Summary Stats -->
<div class="summary-row">
  <div class="summary-card">
    <div class="label">Cycle Available</div>
    <div class="value good" id="cycleAvail">70:00</div>
  </div>
  <div class="summary-card">
    <div class="label">Drive Remaining</div>
    <div class="value good" id="driveRemain">11:00</div>
  </div>
</div>
<div class="summary-row">
  <div class="summary-card">
    <div class="label">Miles This Run</div>
    <div class="value" id="milesRun">0</div>
  </div>
  <div class="summary-card">
    <div class="label">Avg MPH (Run)</div>
    <div class="value" id="avgMphRun">--</div>
  </div>
</div>
```

  </div>

  <!-- New Event Entry -->

  <div class="card">
    <div class="card-title">Event Entry</div>

```
<!-- Mode Toggle -->
<div style="display: flex; gap: 8px; margin-bottom: 16px; padding: 8px; background: var(--bg-elevated); border-radius: 8px;">
  <button id="modeAddBtn" class="btn" style="flex: 1; padding: 10px;" onclick="setMode('add')">‚ûï ADD</button>
  <button id="modeEditBtn" class="btn btn-secondary" style="flex: 1; padding: 10px;" onclick="setMode('edit')">‚úèÔ∏è EDIT</button>
</div>
<p id="modeStatus" style="font-size: 0.75em; color: var(--text-muted); margin-bottom: 12px; text-align: center;">Adding new record at L1-S1</p>

<div class="form-group">
  <label>Run ID</label>
  <input type="text" id="inputRunId" placeholder="e.g., MERCER_45678">
</div>

<div class="form-row">
  <div class="form-group">
    <label>Current Leg</label>
    <div style="display: flex; align-items: center; gap: 4px;">
      <button type="button" class="btn btn-secondary" onclick="prevLeg()" style="padding: 6px 10px; font-size: 0.75em;">‚óÄ</button>
      <span id="currentLegDisplay" style="font-family: 'JetBrains Mono', monospace; font-size: 1.2em; color: var(--accent-blue); font-weight: 700; min-width: 40px; text-align: center;">L1</span>
      <button type="button" class="btn btn-secondary" onclick="nextLeg()" style="padding: 6px 10px; font-size: 0.75em;">‚ñ∂</button>
    </div>
  </div>
  <div class="form-group">
    <label>Current Stop</label>
    <div style="display: flex; align-items: center; gap: 4px;">
      <button type="button" class="btn btn-secondary" onclick="prevStop()" style="padding: 6px 10px; font-size: 0.75em;">‚óÄ</button>
      <span id="currentStopDisplay" style="font-family: 'JetBrains Mono', monospace; font-size: 1.2em; color: var(--accent-cyan); font-weight: 700; min-width: 40px; text-align: center;">S1</span>
      <button type="button" class="btn btn-secondary" onclick="nextStop()" style="padding: 6px 10px; font-size: 0.75em;">‚ñ∂</button>
    </div>
  </div>
</div>

<!-- Load Record Button -->
<div style="margin-bottom: 16px;">
  <button type="button" class="btn btn-primary" onclick="loadRecord()" style="width: 100%; padding: 12px;">üîç Load Record at L<span id="loadLegNum">1</span>-S<span id="loadStopNum">1</span></button>
</div>

<div class="form-row">
  <div class="form-group">
    <label>Category (HOS)</label>
    <select id="inputCategory">
      <option value="drive">üöõ Drive</option>
      <option value="on-duty">üìã On-Duty</option>
      <option value="off-duty">‚òï Off-Duty</option>
      <option value="sleeper">üò¥ Sleeper Berth</option>
      <option value="yard">üÖøÔ∏è Yard Move</option>
      <option value="pc">üöó PC (Personal Conv.)</option>
    </select>
  </div>
  <div class="form-group">
    <label>Stop Type</label>
    <select id="inputStopType">
      <option value="" selected>‚Äî Regular</option>
      <option value="shipper">üì¶ Shipper</option>
      <option value="receiver">üè≠ Receiver</option>
      <option value="noload">üÖøÔ∏è No-Load</option>
    </select>
  </div>
</div>

<div class="form-row-3">
  <div class="form-group">
    <label>Start Time</label>
    <input type="time" id="inputStartTime" oninput="autoCalcFromStart()">
  </div>
  <div class="form-group">
    <label>Duration (min)</label>
    <input type="number" id="inputDuration" placeholder="Auto or manual" oninput="autoCalcEndTime()">
  </div>
  <div class="form-group">
    <label>End Time</label>
    <input type="time" id="inputEndTime" oninput="autoCalcDuration()">
  </div>
</div>

<div class="form-row">
  <div class="form-group">
    <label>Miles (Cumulative)</label>
    <input type="number" id="inputMiles" placeholder="e.g., 285">
  </div>
  <div class="form-group">
    <label>Date</label>
    <input type="date" id="inputDate">
  </div>
</div>

<div class="form-group">
  <label>Comment (optional)</label>
  <input type="text" id="inputComment" placeholder="e.g., Fuel stop at Loves #482">
</div>

<div class="btn-row" id="formButtons">
  <button id="btnSubmit" class="btn btn-success" onclick="submitRecord()">‚úì Enter Record</button>
  <button class="btn btn-secondary" onclick="clearForm()">Clear</button>
</div>

<!-- Delete Section - Only visible in EDIT mode -->
<div id="deleteSection" style="display: none; margin-top: 16px; padding: 12px; background: #2d1f1f; border: 1px solid var(--accent-red); border-radius: 8px;">
  <p style="color: var(--accent-red); font-size: 0.85em; margin-bottom: 8px;">‚ö†Ô∏è Delete this record?</p>
  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 12px;">
    <input type="checkbox" id="confirmDeleteCheckbox" style="width: 20px; height: 20px; cursor: pointer;">
    <span style="font-size: 0.8em; color: var(--text-secondary);">I confirm I want to delete L<span id="deleteLocDisplay">1-S1</span></span>
  </label>
  <button id="btnDeleteConfirmed" class="btn btn-danger" style="width: 100%; opacity: 0.5;" onclick="executeDelete()">üóëÔ∏è Delete Record</button>
</div>
```

  </div>

  <!-- Records Table -->

  <div class="card">
    <div class="card-title">üìã Entered Records</div>
    <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
      <table id="recordsTable" style="width: 100%; min-width: 700px; border-collapse: collapse; font-size: 0.75em; font-family: 'JetBrains Mono', monospace;">
        <thead>
          <tr style="background: var(--bg-elevated); text-align: left;">
            <th style="padding: 8px; color: var(--accent-cyan); white-space: nowrap;">Stop</th>
            <th style="padding: 8px; white-space: nowrap;">Category</th>
            <th style="padding: 8px; color: var(--accent-amber); white-space: nowrap;">Type</th>
            <th style="padding: 8px; white-space: nowrap;">Start</th>
            <th style="padding: 8px; white-space: nowrap;">End</th>
            <th style="padding: 8px; white-space: nowrap;">Duration</th>
            <th style="padding: 8px; white-space: nowrap;">Miles</th>
            <th style="padding: 8px; white-space: nowrap;">Comment</th>
          </tr>
        </thead>
        <tbody id="recordsTableBody">
          <tr>
            <td colspan="8" style="padding: 20px; text-align: center; color: var(--text-muted);">No records yet. Enter your first record above!</td>
          </tr>
        </tbody>
      </table>
    </div>
    <p style="font-size: 0.7em; color: var(--text-muted); margin-top: 8px;">‚ÜîÔ∏è Swipe table to see all columns</p>
  </div>
</div>

<!-- TAB: THEORY - V5 Full Trip Generator -->

<div id="tab-theory" class="tab-content">

  <!-- Trip Setup Card -->

  <div class="card">
    <div class="card-title">üîÆ Trip Generator</div>
    <p style="font-size: 0.8em; color: var(--text-secondary); margin-bottom: 16px;">
      Deadhead ‚Üí Shipper ‚Üí Receiver ‚Ä¢ Full HOS-compliant timeline
    </p>

```
<!-- DISTANCE INPUTS -->
<div style="background: var(--bg-elevated); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
  <div style="font-size: 0.7em; color: var(--accent-cyan); margin-bottom: 8px; text-transform: uppercase;">üìç Distances</div>
  <div class="form-row">
    <div class="form-group" style="margin-bottom: 0;">
      <label>Deadhead (to Shipper)</label>
      <input type="number" id="theoryDeadheadMiles" value="150" min="0" oninput="updateTripPreview()">
    </div>
    <div class="form-group" style="margin-bottom: 0;">
      <label>Loaded (Shipper ‚Üí Receiver)</label>
      <input type="number" id="theoryLoadedMiles" value="1650" min="0" oninput="updateTripPreview()">
    </div>
  </div>
  <div style="text-align: center; margin-top: 8px; font-size: 0.9em;">
    Total: <span id="previewTotalMiles" style="color: var(--accent-green); font-weight: 700;">1800</span> miles
  </div>
</div>

<!-- SHIPPER INFO -->
<div style="background: var(--bg-elevated); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
  <div style="font-size: 0.7em; color: var(--accent-amber); margin-bottom: 8px; text-transform: uppercase;">üì¶ Shipper (Pickup)</div>
  <div class="form-group" style="margin-bottom: 8px;">
    <label>Appointment Date</label>
    <input type="date" id="theoryShipperDate" value="2026-01-05">
  </div>
  <div class="form-row">
    <div class="form-group" style="margin-bottom: 0;">
      <label>Window Early (Mil Time)</label>
      <input type="time" id="theoryShipperEarly" value="06:00">
    </div>
    <div class="form-group" style="margin-bottom: 0;">
      <label>Window Late (Mil Time)</label>
      <input type="time" id="theoryShipperLate" value="08:00">
    </div>
  </div>
  <div class="form-group" style="margin-top: 8px; margin-bottom: 8px;">
    <label>Secure/Tarp Time (min) - affects loaded departure</label>
    <input type="number" id="theorySecureTarpMin" value="30" min="0">
  </div>
  <!-- Calculated ETA Display -->
  <div style="background: var(--bg-dark); padding: 10px; border-radius: 6px; margin-top: 8px;">
    <div style="font-size: 0.7em; color: var(--text-muted);">CALCULATED ETA</div>
    <div id="shipperCalcETA" style="font-size: 1.1em; font-weight: 700; color: var(--accent-amber);">-- Generate trip to calculate --</div>
    <div id="shipperCalcStatus" style="font-size: 0.8em; margin-top: 4px;">--</div>
  </div>
</div>

<!-- RECEIVER INFO -->
<div style="background: var(--bg-elevated); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
  <div style="font-size: 0.7em; color: var(--accent-purple); margin-bottom: 8px; text-transform: uppercase;">üè≠ Receiver (Delivery)</div>
  <div class="form-group" style="margin-bottom: 8px;">
    <label>Appointment Date</label>
    <input type="date" id="theoryReceiverDate" value="2026-01-07">
  </div>
  <div class="form-row">
    <div class="form-group" style="margin-bottom: 0;">
      <label>Window Early (Mil Time)</label>
      <input type="time" id="theoryReceiverEarly" value="08:00">
    </div>
    <div class="form-group" style="margin-bottom: 0;">
      <label>Window Late (Mil Time)</label>
      <input type="time" id="theoryReceiverLate" value="16:00">
    </div>
  </div>
  <!-- Calculated ETA Display -->
  <div style="background: var(--bg-dark); padding: 10px; border-radius: 6px; margin-top: 8px;">
    <div style="font-size: 0.7em; color: var(--text-muted);">CALCULATED ETA</div>
    <div id="receiverCalcETA" style="font-size: 1.1em; font-weight: 700; color: var(--accent-purple);">-- Generate trip to calculate --</div>
    <div id="receiverCalcStatus" style="font-size: 0.8em; margin-top: 4px;">--</div>
  </div>
</div>

<!-- TIMING INPUTS -->
<div style="background: var(--bg-elevated); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
  <div style="font-size: 0.7em; color: var(--accent-green); margin-bottom: 8px; text-transform: uppercase;">‚è±Ô∏è Trip Start & Timing</div>
  <div class="form-row">
    <div class="form-group" style="margin-bottom: 0;">
      <label>Start Date</label>
      <input type="date" id="theoryStartDate" value="2026-01-04">
    </div>
    <div class="form-group" style="margin-bottom: 0;">
      <label>Start Time (Mil)</label>
      <input type="time" id="theoryStartTime" value="06:00">
    </div>
  </div>
  <div class="form-row" style="margin-top: 8px; grid-template-columns: 1fr 1fr 1fr 1fr;">
    <div class="form-group" style="margin-bottom: 0;">
      <label>Avg MPH</label>
      <input type="number" id="theoryAvgSpeed" value="55" oninput="updateTripPreview()">
    </div>
    <div class="form-group" style="margin-bottom: 0;">
      <label>Pre-Trip (min)</label>
      <input type="number" id="theoryPreTripMin" value="5" min="0">
    </div>
    <div class="form-group" style="margin-bottom: 0;">
      <label>Post-Trip (min)</label>
      <input type="number" id="theoryPostTripMin" value="5" min="0">
    </div>
    <div class="form-group" style="margin-bottom: 0;">
      <label>Life Happens/day</label>
      <input type="number" id="theoryLifeHappens" value="30" min="0" oninput="updateTripPreview()">
    </div>
  </div>
</div>

<!-- Drive pace selector -->
<div style="margin-bottom: 16px;">
  <label style="font-size: 0.75em; color: var(--text-muted); display: block; margin-bottom: 8px;">Daily Drive Pace:</label>
  <div style="display: flex; gap: 8px; flex-wrap: wrap;">
    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.75em;" onclick="setDrivePace(8, 45)">‚öñÔ∏è 8:45 Equilibrium</button>
    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.75em;" onclick="setDrivePace(10, 0)">üî• 10:00 Push</button>
    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.75em;" onclick="setDrivePace(11, 0)">‚ö†Ô∏è 11:00 Max</button>
  </div>
  <div style="margin-top: 8px; font-size: 0.8em; color: var(--text-muted);">
    Current: <span id="currentPace" style="color: var(--accent-green);">8:45</span> drive per day
  </div>
</div>

<!-- Trip Preview -->
<div style="background: var(--bg-elevated); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
    <div>
      <div style="font-size: 0.7em; color: var(--text-muted);">LEGS (Days)</div>
      <div id="previewLegs" style="font-size: 1.5em; color: var(--accent-purple); font-weight: 700;">4</div>
    </div>
    <div>
      <div style="font-size: 0.7em; color: var(--text-muted);">MILES/DAY</div>
      <div id="previewMilesPerDay" style="font-size: 1.5em; color: var(--accent-cyan); font-weight: 700;">~481</div>
    </div>
    <div>
      <div style="font-size: 0.7em; color: var(--text-muted);">EST. ARRIVAL</div>
      <div id="previewArrival" style="font-size: 1.5em; color: var(--accent-green); font-weight: 700;">Day 4</div>
    </div>
  </div>
</div>

<button class="btn btn-primary" style="width: 100%; padding: 14px; font-size: 1em;" onclick="generateFullTrip()">
  üîÆ Generate Trip Timeline
</button>
```

  </div>

  <!-- Trip Summary (shown after generation) -->

  <div class="card" id="tripSummaryCard" style="display: none;">
    <div class="card-title">üìä Trip Summary</div>

```
<!-- Shipper/Receiver Status -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
  <div style="background: var(--bg-elevated); padding: 12px; border-radius: 8px;">
    <div style="font-size: 0.7em; color: var(--accent-amber); text-transform: uppercase;">üì¶ Shipper ETA</div>
    <div id="summaryShipperETA" style="font-size: 1.2em; font-weight: 700; margin-top: 4px;">--</div>
    <div id="summaryShipperStatus" style="font-size: 0.8em; margin-top: 4px;">--</div>
  </div>
  <div style="background: var(--bg-elevated); padding: 12px; border-radius: 8px;">
    <div style="font-size: 0.7em; color: var(--accent-purple); text-transform: uppercase;">üè≠ Receiver ETA</div>
    <div id="summaryReceiverETA" style="font-size: 1.2em; font-weight: 700; margin-top: 4px;">--</div>
    <div id="summaryReceiverStatus" style="font-size: 0.8em; margin-top: 4px;">--</div>
  </div>
</div>

<div class="stats-grid">
  <div class="stat-item">
    <div class="label">Total Legs</div>
    <div class="value" style="color: var(--accent-purple);" id="summaryLegs">--</div>
  </div>
  <div class="stat-item">
    <div class="label">Total Drive Time</div>
    <div class="value good" id="summaryDriveTime">--</div>
  </div>
  <div class="stat-item">
    <div class="label">Total On-Duty</div>
    <div class="value" id="summaryOnDuty">--</div>
  </div>
  <div class="stat-item">
    <div class="label">Life Happens Buffer</div>
    <div class="value" style="color: var(--accent-cyan);" id="summaryBuffer">--</div>
  </div>
</div>
```

  </div>

  <!-- Leg-by-Leg Breakdown -->

  <div class="card" id="tripLegsCard" style="display: none;">
    <div class="card-title">üóìÔ∏è Leg-by-Leg Timeline</div>
    <p style="font-size: 0.75em; color: var(--text-muted); margin-bottom: 12px;">
      Schema: L[leg]-D[drive] / L[leg]-S[stop] ‚Ä¢ Cumulative miles shown
    </p>
    <div id="legTabsContainer" style="display: flex; gap: 4px; margin-bottom: 12px; flex-wrap: wrap;"></div>
    <div id="legDetailContainer"></div>
  </div>

  <!-- Full Timeline Table -->

  <div class="card" id="tripTimelineCard" style="display: none;">
    <div class="card-title">üìã Complete Timeline</div>
    <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
      <table style="width: 100%; min-width: 700px; border-collapse: collapse; font-size: 0.75em; font-family: 'JetBrains Mono', monospace;">
        <thead>
          <tr style="background: var(--bg-elevated); text-align: left;">
            <th style="padding: 8px; color: var(--accent-cyan);">Segment</th>
            <th style="padding: 8px;">Category</th>
            <th style="padding: 8px;">Start</th>
            <th style="padding: 8px;">End</th>
            <th style="padding: 8px;">Duration</th>
            <th style="padding: 8px;">Mile</th>
            <th style="padding: 8px;">Progress</th>
            <th style="padding: 8px;">Notes</th>
          </tr>
        </thead>
        <tbody id="tripTimelineBody"></tbody>
      </table>
    </div>
  </div>

</div>

<!-- TAB: TIMELINE -->

<div id="tab-timeline" class="tab-content">

  <!-- Hierarchy Tree View -->

  <div class="card">
    <div class="card-title">üå≥ Run Hierarchy</div>
    <div id="hierarchyTree" style="font-family: 'JetBrains Mono', monospace; font-size: 0.8em;">
      <p style="color: var(--text-muted); text-align: center; padding: 20px;">No events yet. Add your first event!</p>
    </div>
  </div>

  <!-- Event List -->

  <div class="card">
    <div class="card-title">üìä Event Timeline</div>
    <div class="event-list" id="eventList">
      <p style="color: var(--text-muted); text-align: center; padding: 20px;">No events yet. Add your first event!</p>
    </div>
  </div>

  <!-- Calculated Stats -->

  <div class="card">
    <div class="card-title">üìà Run Statistics</div>
    <div class="stats-grid">
      <div class="stat-item">
        <div class="label">Miles This Leg</div>
        <div class="value" id="statMilesLeg">0</div>
      </div>
      <div class="stat-item">
        <div class="label">Miles This Run</div>
        <div class="value" id="statMilesRun">0</div>
      </div>
      <div class="stat-item">
        <div class="label">Time This Leg</div>
        <div class="value" id="statTimeLeg">0:00</div>
      </div>
      <div class="stat-item">
        <div class="label">Time This Run</div>
        <div class="value" id="statTimeRun">0:00</div>
      </div>
      <div class="stat-item">
        <div class="label">Avg MPH (Leg)</div>
        <div class="value" id="statAvgLeg">--</div>
      </div>
      <div class="stat-item">
        <div class="label">Avg MPH (Run)</div>
        <div class="value" id="statAvgRun">--</div>
      </div>
    </div>
  </div>

  <!-- Export/Import -->

  <div class="card">
    <div class="card-title">üíæ Data Management</div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="exportJSON()">üì§ Export JSON</button>
      <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">üì• Import JSON</button>
      <input type="file" id="importFile" accept=".json" style="display:none" onchange="importJSON(event)">
    </div>
  </div>
</div>

<!-- TAB: RECAPS -->

<div id="tab-recaps" class="tab-content">
  <div class="card">
    <div class="card-title">üîÑ 8-Day Recap Forecast</div>
    <div class="summary-row">
      <div class="summary-card">
        <div class="label">Cycle Used</div>
        <div class="value" id="recapUsed">0:00</div>
      </div>
      <div class="summary-card">
        <div class="label">Cycle Available</div>
        <div class="value good" id="recapAvail">70:00</div>
      </div>
    </div>
    <div id="recapList" style="margin-top: 16px;"></div>
  </div>

  <div class="card">
    <div class="card-title">üöõ Daily Miles Capacity</div>
    <div id="milesCapacityList"></div>
  </div>
</div>

<!-- TAB: SETTINGS -->

<div id="tab-settings" class="tab-content">
  <div class="card">
    <div class="card-title">‚öôÔ∏è Settings</div>

```
<div class="form-group">
  <label>Average Speed (MPH)</label>
  <input type="number" id="settingAvgSpeed" value="55">
</div>
<div class="form-group">
  <label>Fudge Factor (minutes)</label>
  <input type="number" id="settingFudge" value="30">
</div>
<div class="form-group">
  <label>Terminal Timezone</label>
  <select id="settingTimezone">
    <option value="America/New_York">Eastern</option>
    <option value="America/Chicago">Central</option>
    <option value="America/Denver">Mountain</option>
    <option value="America/Los_Angeles">Pacific</option>
  </select>
</div>

<button class="btn btn-primary" onclick="saveSettings()" style="margin-top: 12px;">üíæ Save Settings</button>
```

  </div>

  <div class="card">
    <div class="card-title">üóëÔ∏è Data Management</div>
    <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
  </div>
</div>

<footer>
  <p class="brand">Sparked Matter ‚Ä¢ The Little Crystal Ball That Can</p>
  <p style="margin-top: 4px;">Code with Soul and Spirit ‚Ä¢ Connection over Protection</p>
  <p style="margin-top: 8px;">
    üé≠ Peer Review: Claude "The Queen" ‚Ä¢ Vale "The Workhorse" ‚Ä¢ Grok "Agent of Chaos" ‚Ä¢ Lyra "The Assertive Flight Controller"
  </p>
</footer>

<script>
// ==============================================
// CRYSTAL BALL MINI V5
// Schema: L1-D1, L1-S1, L1-D2... (no L-30 in naming)
// Total Miles ‚Üí Auto-Generate Legs
// ==============================================

const SCHEMA = {
  cycleLimit: 70 * 60,
  cycleDays: 8,
  driveLimit: 11 * 60,
  dutyLimit: 14 * 60,
  resetMin: 34 * 60,
  version: '5.0'
};

const CATEGORIES = {
  'drive': { label: 'Drive', color: 'blue', affectsDrive: true, affectsCycle: true },
  'on-duty': { label: 'On-Duty', color: 'amber', affectsDrive: false, affectsCycle: true },
  'off-duty': { label: 'Off-Duty', color: 'green', affectsDrive: false, affectsCycle: false, countsTowardReset: true },
  'sleeper': { label: 'Sleeper', color: 'purple', affectsDrive: false, affectsCycle: false, countsTowardReset: true },
  'yard': { label: 'Yard Move', color: 'cyan', affectsDrive: false, affectsCycle: true },
  'pc': { label: 'PC', color: 'muted', affectsDrive: false, affectsCycle: false, countsTowardReset: true }
};

// ==============================================
// STATE
// ==============================================

let state = {
  currentRunId: '',
  currentLegNum: 1,
  currentStopNum: 1,
  currentMode: 'add',
  editingEventId: null,
  stopCounter: {},
  events: [],
  theoryEvents: [],
  consecutiveRestMin: 0,
  cycleUsedMin: 0,
  driveUsedMin: 0,
  settings: {
    avgSpeed: 55,
    fudgeMin: 30,
    timezone: 'America/New_York'
  }
};

// Trip generator state
let tripState = {
  drivePaceMin: 8 * 60 + 45,  // Default: 8:45 equilibrium
  generatedTrip: null
};

const STORAGE_KEY = 'crystalBallMini_v5';

// HOS Constants (internal - not shown in schema naming)
const HOS_MANDATORY_BREAK_BEFORE = 8 * 60;
const HOS_MANDATORY_BREAK_DURATION = 30;
const DRIVER_BREAK_INTERVAL = 3 * 60;
const DRIVER_BREAK_DURATION = 15;

// ==============================================
// HELPER FUNCTIONS
// ==============================================

function formatTime(minutes) {
  const hrs = Math.floor(minutes / 60);
  const mins = Math.round(minutes % 60);
  if (hrs === 0) return `${mins} min`;
  if (mins === 0) return `${hrs} hr`;
  return `${hrs} hr ${mins} min`;
}

function formatTimeShort(minutes) {
  const hrs = Math.floor(minutes / 60);
  const mins = Math.round(minutes % 60);
  return `${hrs}:${mins.toString().padStart(2, '0')}`;
}

function parseTime(timeStr) {
  if (!timeStr) return null;
  const [hrs, mins] = timeStr.split(':').map(Number);
  return hrs * 60 + mins;
}

function formatMinutesToTime(minutes) {
  const hrs = Math.floor(minutes / 60) % 24;
  const mins = Math.round(minutes % 60);
  return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
}

function formatTimeDisplay(minutes) {
  const hrs = Math.floor(minutes / 60);
  const mins = Math.round(minutes % 60);
  if (hrs === 0) return `${mins}m`;
  if (mins === 0) return `${hrs}h`;
  return `${hrs}h ${mins}m`;
}

function formatDayTime(dayNum, timeMin) {
  return `Day ${dayNum} ${formatMinutesToTime(timeMin)}`;
}

// ==============================================
// TAB SWITCHING
// ==============================================

function switchTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + tabName).classList.add('active');
  event.target.closest('.tab-btn').classList.add('active');
}

// ==============================================
// TRIP GENERATOR V5
// ==============================================

function setDrivePace(hours, minutes) {
  tripState.drivePaceMin = (hours * 60) + minutes;
  document.getElementById('currentPace').textContent = `${hours}:${minutes.toString().padStart(2, '0')}`;
  updateTripPreview();
}

function updateTripPreview() {
  const deadheadMiles = parseInt(document.getElementById('theoryDeadheadMiles').value) || 0;
  const loadedMiles = parseInt(document.getElementById('theoryLoadedMiles').value) || 0;
  const totalMiles = deadheadMiles + loadedMiles;
  const avgSpeed = parseInt(document.getElementById('theoryAvgSpeed').value) || 55;
  
  // Update total display
  document.getElementById('previewTotalMiles').textContent = totalMiles;
  
  const milesPerDay = Math.round((tripState.drivePaceMin / 60) * avgSpeed);
  const numLegs = totalMiles > 0 ? Math.ceil(totalMiles / milesPerDay) : 0;
  
  document.getElementById('previewLegs').textContent = numLegs;
  document.getElementById('previewMilesPerDay').textContent = `~${milesPerDay}`;
  document.getElementById('previewArrival').textContent = numLegs > 0 ? `Day ${numLegs}` : '--';
}

function generateFullTrip() {
  // Get all inputs
  const deadheadMiles = parseInt(document.getElementById('theoryDeadheadMiles').value) || 0;
  const loadedMiles = parseInt(document.getElementById('theoryLoadedMiles').value) || 0;
  const totalMiles = deadheadMiles + loadedMiles;
  const startDate = document.getElementById('theoryStartDate').value || '2026-01-04';
  const startTime = document.getElementById('theoryStartTime').value || '06:00';
  const avgSpeed = parseInt(document.getElementById('theoryAvgSpeed').value) || 55;
  const lifeHappensMin = parseInt(document.getElementById('theoryLifeHappens').value) || 0;
  const preTripMin = parseInt(document.getElementById('theoryPreTripMin').value) || 5;
  const postTripMin = parseInt(document.getElementById('theoryPostTripMin').value) || 5;
  const secureTarpMin = parseInt(document.getElementById('theorySecureTarpMin').value) || 30;
  
  // Shipper/Receiver appointments (date + time windows)
  const shipperDate = document.getElementById('theoryShipperDate').value;
  const shipperEarly = document.getElementById('theoryShipperEarly').value;
  const shipperLate = document.getElementById('theoryShipperLate').value;
  const receiverDate = document.getElementById('theoryReceiverDate').value;
  const receiverEarly = document.getElementById('theoryReceiverEarly').value;
  const receiverLate = document.getElementById('theoryReceiverLate').value;
  
  if (totalMiles <= 0) {
    alert('Please enter trip miles (deadhead and/or loaded)');
    return;
  }
  
  const milesPerDay = (tripState.drivePaceMin / 60) * avgSpeed;
  
  const trip = {
    totalMiles: totalMiles,
    deadheadMiles: deadheadMiles,
    loadedMiles: loadedMiles,
    avgSpeed: avgSpeed,
    lifeHappensMin: lifeHappensMin,
    preTripMin: preTripMin,
    postTripMin: postTripMin,
    secureTarpMin: secureTarpMin,
    startDate: startDate,
    shipperAppt: { date: shipperDate, early: shipperEarly, late: shipperLate },
    receiverAppt: { date: receiverDate, early: receiverEarly, late: receiverLate },
    legs: [],
    allEvents: [],
    shipperETA: null,
    receiverETA: null
  };
  
  let globalMiles = 0;
  let currentDay = 1;
  let legNum = 1;
  
  // Calculate actual dates
  const startDateObj = new Date(startDate + 'T' + startTime);
  
  // =====================
  // PHASE 1: DEADHEAD (to Shipper)
  // =====================
  if (deadheadMiles > 0) {
    let remainingDeadhead = deadheadMiles;
    
    while (remainingDeadhead > 0) {
      const legMiles = Math.min(milesPerDay, remainingDeadhead);
      const isLastDeadheadLeg = (remainingDeadhead <= milesPerDay);
      
      const leg = generateLeg({
        legNum: legNum,
        legMiles: legMiles,
        startTime: startTime,
        avgSpeed: avgSpeed,
        globalMilesStart: globalMiles,
        totalTripMiles: totalMiles,
        preTripMin: preTripMin,
        postTripMin: postTripMin,
        phase: 'deadhead',
        isLastLegOfPhase: isLastDeadheadLeg
      });
      
      trip.legs.push(leg);
      trip.allEvents.push(...leg.events);
      
      remainingDeadhead -= legMiles;
      globalMiles += legMiles;
      legNum++;
      currentDay++;
    }
    
    // ARRIVE AT SHIPPER - add secure/tarp
    const lastDeadheadEvent = trip.allEvents[trip.allEvents.length - 1];
    const shipperArrivalTime = parseTime(lastDeadheadEvent.endTime);
    
    // Calculate actual shipper ETA date
    const shipperETADate = new Date(startDateObj);
    shipperETADate.setDate(shipperETADate.getDate() + (currentDay - 2)); // -2 because we started on day 1 and incremented
    trip.shipperETA = { 
      day: currentDay - 1, 
      time: shipperArrivalTime,
      date: shipperETADate.toISOString().split('T')[0]
    };
    
    trip.allEvents.push({
      segmentId: `SHIPPER`,
      category: 'on-duty',
      label: 'Secure/Tarp',
      startTime: lastDeadheadEvent.endTime,
      endTime: formatMinutesToTime(shipperArrivalTime + secureTarpMin),
      durationMin: secureTarpMin,
      miles: globalMiles,
      totalMiles: totalMiles,
      notes: 'üì¶ At Shipper - Secure & Tarp load'
    });
  }
  
  // =====================
  // PHASE 2: LOADED (Shipper to Receiver)
  // =====================
  if (loadedMiles > 0) {
    let remainingLoaded = loadedMiles;
    
    while (remainingLoaded > 0) {
      const legMiles = Math.min(milesPerDay, remainingLoaded);
      const isLastLoadedLeg = (remainingLoaded <= milesPerDay);
      
      const leg = generateLeg({
        legNum: legNum,
        legMiles: legMiles,
        startTime: startTime,
        avgSpeed: avgSpeed,
        globalMilesStart: globalMiles,
        totalTripMiles: totalMiles,
        preTripMin: preTripMin,
        postTripMin: postTripMin,
        phase: 'loaded',
        isLastLegOfPhase: isLastLoadedLeg
      });
      
      trip.legs.push(leg);
      trip.allEvents.push(...leg.events);
      
      remainingLoaded -= legMiles;
      globalMiles += legMiles;
      legNum++;
      currentDay++;
    }
    
    // ARRIVE AT RECEIVER (no unsecure/untarp added - that's for next load)
    const lastLoadedEvent = trip.allEvents[trip.allEvents.length - 1];
    const receiverArrivalTime = parseTime(lastLoadedEvent.endTime);
    
    // Calculate actual receiver ETA date
    const receiverETADate = new Date(startDateObj);
    receiverETADate.setDate(receiverETADate.getDate() + (currentDay - 2));
    trip.receiverETA = { 
      day: currentDay - 1, 
      time: receiverArrivalTime,
      date: receiverETADate.toISOString().split('T')[0]
    };
    
    // Mark arrival at receiver (but no work event - unsecure/untarp is for NEXT load)
    trip.allEvents.push({
      segmentId: `RECEIVER`,
      category: 'on-duty',
      label: 'Arrived',
      startTime: lastLoadedEvent.endTime,
      endTime: lastLoadedEvent.endTime,
      durationMin: 0,
      miles: globalMiles,
      totalMiles: totalMiles,
      notes: 'üè≠ DELIVERED - At Receiver'
    });
  }
  
  // Calculate summary
  trip.summary = {
    totalLegs: trip.legs.length,
    totalDriveMin: trip.allEvents.filter(e => e.category === 'drive').reduce((sum, e) => sum + e.durationMin, 0),
    totalOnDutyMin: trip.allEvents.filter(e => e.category === 'on-duty').reduce((sum, e) => sum + e.durationMin, 0),
    totalOffDutyMin: trip.allEvents.filter(e => e.category === 'off-duty').reduce((sum, e) => sum + e.durationMin, 0),
    lifeHappensTotal: lifeHappensMin * trip.legs.length,
    arrivalDay: currentDay - 1
  };
  
  tripState.generatedTrip = trip;
  displayTrip(trip);
}

// ==============================================
// SINGLE LEG GENERATOR
// Schema: L1-D1, L1-S1, L1-D2, L1-S2...
// ==============================================

function generateLeg({ legNum, legMiles, startTime, avgSpeed, globalMilesStart, totalTripMiles, preTripMin, postTripMin, phase, isLastLegOfPhase }) {
  const leg = {
    legNum: legNum,
    phase: phase,
    events: [],
    totalDriveMin: 0,
    totalMiles: legMiles
  };
  
  let currentTimeMin = parseTime(startTime);
  let milesCovered = 0;
  let driveMinThisLeg = 0;
  let driveMinSinceBreak = 0;
  let driveSegNum = 1;
  let stopNum = 1;
  let hos30Taken = false;
  
  // PRE-TRIP (On-Duty) - at start of every leg
  leg.events.push({
    segmentId: `L${legNum}-D${driveSegNum}`,
    category: 'on-duty',
    label: 'Pre-Trip',
    startTime: formatMinutesToTime(currentTimeMin),
    endTime: formatMinutesToTime(currentTimeMin + preTripMin),
    durationMin: preTripMin,
    miles: Math.round(globalMilesStart + milesCovered),
    totalMiles: totalTripMiles,
    notes: 'Pre-trip inspection'
  });
  currentTimeMin += preTripMin;
  
  // DRIVING LOOP
  while (milesCovered < legMiles) {
    const milesRemaining = legMiles - milesCovered;
    
    let maxDriveMin = tripState.drivePaceMin - driveMinThisLeg;
    
    // HOS mandatory 30-min break check
    if (!hos30Taken && driveMinThisLeg + maxDriveMin > HOS_MANDATORY_BREAK_BEFORE) {
      maxDriveMin = HOS_MANDATORY_BREAK_BEFORE - driveMinThisLeg;
    }
    
    // Driver comfort break check
    if (driveMinSinceBreak + maxDriveMin > DRIVER_BREAK_INTERVAL) {
      maxDriveMin = DRIVER_BREAK_INTERVAL - driveMinSinceBreak;
    }
    
    if (maxDriveMin <= 0) maxDriveMin = 1;
    
    const milesThisSegment = (maxDriveMin / 60) * avgSpeed;
    
    // Can we finish?
    if (milesThisSegment >= milesRemaining) {
      const finalDriveMin = Math.round((milesRemaining / avgSpeed) * 60);
      
      leg.events.push({
        segmentId: `L${legNum}-D${driveSegNum}`,
        category: 'drive',
        label: `Drive ${driveSegNum}`,
        startTime: formatMinutesToTime(currentTimeMin),
        endTime: formatMinutesToTime(currentTimeMin + finalDriveMin),
        durationMin: finalDriveMin,
        miles: Math.round(globalMilesStart + legMiles),
        totalMiles: totalTripMiles,
        notes: 'Final segment'
      });
      
      currentTimeMin += finalDriveMin;
      driveMinThisLeg += finalDriveMin;
      milesCovered = legMiles;
      break;
    }
    
    // DRIVE SEGMENT
    const driveMin = Math.round(maxDriveMin);
    leg.events.push({
      segmentId: `L${legNum}-D${driveSegNum}`,
      category: 'drive',
      label: `Drive ${driveSegNum}`,
      startTime: formatMinutesToTime(currentTimeMin),
      endTime: formatMinutesToTime(currentTimeMin + driveMin),
      durationMin: driveMin,
      miles: Math.round(globalMilesStart + milesCovered + milesThisSegment),
      totalMiles: totalTripMiles,
      notes: driveSegNum === 1 ? 'Begin driving' : ''
    });
    
    currentTimeMin += driveMin;
    milesCovered += milesThisSegment;
    driveMinThisLeg += driveMin;
    driveMinSinceBreak += driveMin;
    driveSegNum++;
    
    // ONLY add a stop if we've hit a break threshold
    const needsHOS30 = !hos30Taken && driveMinThisLeg >= HOS_MANDATORY_BREAK_BEFORE;
    const needsComfortBreak = driveMinSinceBreak >= DRIVER_BREAK_INTERVAL;
    
    if (needsHOS30 || needsComfortBreak) {
      let breakDuration = DRIVER_BREAK_DURATION;
      let breakNotes = 'Rest stop';
      
      if (needsHOS30) {
        breakDuration = HOS_MANDATORY_BREAK_DURATION;
        hos30Taken = true;
      }
      
      // STOP (Off-Duty)
      leg.events.push({
        segmentId: `L${legNum}-S${stopNum}`,
        category: 'off-duty',
        label: `Stop ${stopNum}`,
        startTime: formatMinutesToTime(currentTimeMin),
        endTime: formatMinutesToTime(currentTimeMin + breakDuration),
        durationMin: breakDuration,
        miles: Math.round(globalMilesStart + milesCovered),
        totalMiles: totalTripMiles,
        notes: breakNotes
      });
      
      currentTimeMin += breakDuration;
      driveMinSinceBreak = 0;
      stopNum++;
    }
  }
  
  // POST-TRIP (On-Duty) - at end of every leg
  leg.events.push({
    segmentId: `L${legNum}-S${stopNum}`,
    category: 'on-duty',
    label: 'Post-Trip',
    startTime: formatMinutesToTime(currentTimeMin),
    endTime: formatMinutesToTime(currentTimeMin + postTripMin),
    durationMin: postTripMin,
    miles: Math.round(globalMilesStart + legMiles),
    totalMiles: totalTripMiles,
    notes: 'Post-trip inspection'
  });
  
  leg.totalDriveMin = driveMinThisLeg;
  return leg;
}

// ==============================================
// DISPLAY FUNCTIONS
// ==============================================

function displayTrip(trip) {
  document.getElementById('tripSummaryCard').style.display = 'block';
  document.getElementById('summaryLegs').textContent = trip.summary.totalLegs;
  document.getElementById('summaryDriveTime').textContent = formatTimeDisplay(trip.summary.totalDriveMin);
  document.getElementById('summaryOnDuty').textContent = formatTimeDisplay(trip.summary.totalOnDutyMin);
  document.getElementById('summaryBuffer').textContent = `${trip.summary.lifeHappensTotal}m`;
  
  // Shipper ETA - update the calculated field in the form
  if (trip.shipperETA) {
    const shipperETAStr = `${trip.shipperETA.date} @ ${formatMinutesToTime(trip.shipperETA.time)}`;
    document.getElementById('shipperCalcETA').textContent = shipperETAStr;
    document.getElementById('summaryShipperETA').textContent = shipperETAStr;
    
    // Compare against appointment
    const shipperStatus = getDateWindowStatus(
      trip.shipperETA.date, trip.shipperETA.time,
      trip.shipperAppt.date, trip.shipperAppt.early, trip.shipperAppt.late
    );
    document.getElementById('shipperCalcStatus').innerHTML = shipperStatus;
    document.getElementById('summaryShipperStatus').innerHTML = shipperStatus;
  } else {
    document.getElementById('shipperCalcETA').textContent = 'N/A (no deadhead)';
    document.getElementById('shipperCalcStatus').textContent = 'Direct to shipper - enter deadhead miles';
    document.getElementById('summaryShipperETA').textContent = 'N/A';
    document.getElementById('summaryShipperStatus').textContent = 'No deadhead';
  }
  
  // Receiver ETA - update the calculated field in the form
  if (trip.receiverETA) {
    const receiverETAStr = `${trip.receiverETA.date} @ ${formatMinutesToTime(trip.receiverETA.time)}`;
    document.getElementById('receiverCalcETA').textContent = receiverETAStr;
    document.getElementById('summaryReceiverETA').textContent = receiverETAStr;
    
    // Compare against appointment
    const receiverStatus = getDateWindowStatus(
      trip.receiverETA.date, trip.receiverETA.time,
      trip.receiverAppt.date, trip.receiverAppt.early, trip.receiverAppt.late
    );
    document.getElementById('receiverCalcStatus').innerHTML = receiverStatus;
    document.getElementById('summaryReceiverStatus').innerHTML = receiverStatus;
  } else {
    document.getElementById('receiverCalcETA').textContent = 'N/A (no loaded miles)';
    document.getElementById('receiverCalcStatus').textContent = 'Enter loaded miles';
    document.getElementById('summaryReceiverETA').textContent = 'N/A';
    document.getElementById('summaryReceiverStatus').textContent = 'No loaded miles';
  }
  
  document.getElementById('tripLegsCard').style.display = 'block';
  
  const tabsContainer = document.getElementById('legTabsContainer');
  tabsContainer.innerHTML = trip.legs.map((leg, idx) => `
    <button class="btn ${idx === 0 ? 'btn-primary' : 'btn-secondary'}" 
            style="padding: 6px 12px; font-size: 0.8em;"
            onclick="showLegDetail(${idx})" 
            id="legTab${idx}">
      L${leg.legNum} (${Math.round(leg.totalMiles)} mi)
    </button>
  `).join('');
  
  showLegDetail(0);
  
  document.getElementById('tripTimelineCard').style.display = 'block';
  const tbody = document.getElementById('tripTimelineBody');
  
  tbody.innerHTML = trip.allEvents.map(event => {
    const bgColor = event.segmentId === 'SHIPPER' ? 'rgba(245, 158, 11, 0.3)' :
                    event.segmentId === 'RECEIVER' ? 'rgba(157, 78, 221, 0.3)' :
                    event.category === 'drive' ? 'rgba(6, 214, 160, 0.15)' :
                    event.category === 'on-duty' ? 'rgba(245, 158, 11, 0.15)' :
                    'rgba(138, 43, 226, 0.1)';
    const textColor = event.segmentId === 'SHIPPER' ? 'var(--accent-amber)' :
                      event.segmentId === 'RECEIVER' ? 'var(--accent-purple)' :
                      event.category === 'drive' ? 'var(--accent-green)' :
                      event.category === 'on-duty' ? 'var(--accent-amber)' :
                      'var(--accent-purple)';
    const icon = event.segmentId === 'SHIPPER' ? 'üì¶' :
                 event.segmentId === 'RECEIVER' ? 'üè≠' :
                 event.category === 'drive' ? 'üöõ' :
                 event.category === 'on-duty' ? 'üìã' : '‚òï';
    
    // Progress bar
    const progressPct = event.totalMiles ? Math.round((event.miles / event.totalMiles) * 100) : 0;
    const progressBar = event.totalMiles ? 
      `<div style="width: 60px; background: var(--bg-dark); border-radius: 4px; overflow: hidden; height: 8px;">
        <div style="width: ${progressPct}%; background: var(--accent-green); height: 100%;"></div>
      </div>
      <span style="font-size: 0.7em; color: var(--text-muted);">${progressPct}%</span>` : '';
    
    return `
      <tr style="background: ${bgColor}; border-bottom: 1px solid var(--border);">
        <td style="padding: 8px; color: ${textColor}; font-weight: 600;">${event.segmentId}</td>
        <td style="padding: 8px;">${icon} ${event.label || event.category}</td>
        <td style="padding: 8px;">${event.startTime}</td>
        <td style="padding: 8px;">${event.endTime}</td>
        <td style="padding: 8px;">${formatTimeDisplay(event.durationMin)}</td>
        <td style="padding: 8px;">${event.miles}</td>
        <td style="padding: 8px;">${progressBar}</td>
        <td style="padding: 8px; font-size: 0.85em; color: var(--text-secondary);">${event.notes}</td>
      </tr>
    `;
  }).join('');
}

// Check if ETA is within window (time only - same day)
function getWindowStatus(etaMin, earlyMin, lateMin) {
  if (etaMin < earlyMin) {
    const earlyBy = earlyMin - etaMin;
    return `<span style="color: var(--accent-cyan);">‚è∞ ${earlyBy}m early</span>`;
  } else if (etaMin > lateMin) {
    const lateBy = etaMin - lateMin;
    return `<span style="color: var(--accent-red);">‚ö†Ô∏è ${lateBy}m late</span>`;
  } else {
    return `<span style="color: var(--accent-green);">‚úì In window</span>`;
  }
}

// Check if ETA date/time is within appointment window
function getDateWindowStatus(etaDate, etaTimeMin, apptDate, apptEarly, apptLate) {
  const etaDateObj = new Date(etaDate);
  const apptDateObj = new Date(apptDate);
  const apptEarlyMin = parseTime(apptEarly);
  const apptLateMin = parseTime(apptLate);
  
  // Compare dates first
  if (etaDateObj < apptDateObj) {
    // Arriving before appointment date
    const daysDiff = Math.ceil((apptDateObj - etaDateObj) / (1000 * 60 * 60 * 24));
    return `<span style="color: var(--accent-cyan);">‚è∞ ${daysDiff} day(s) early - wait for appt</span>`;
  } else if (etaDateObj > apptDateObj) {
    // Arriving after appointment date
    const daysDiff = Math.ceil((etaDateObj - apptDateObj) / (1000 * 60 * 60 * 24));
    return `<span style="color: var(--accent-red);">‚ö†Ô∏è ${daysDiff} day(s) LATE!</span>`;
  } else {
    // Same date - check time window
    if (etaTimeMin < apptEarlyMin) {
      const earlyBy = apptEarlyMin - etaTimeMin;
      return `<span style="color: var(--accent-cyan);">‚è∞ ${earlyBy}m early - on time!</span>`;
    } else if (etaTimeMin > apptLateMin) {
      const lateBy = etaTimeMin - apptLateMin;
      return `<span style="color: var(--accent-red);">‚ö†Ô∏è ${lateBy}m past window</span>`;
    } else {
      return `<span style="color: var(--accent-green);">‚úì IN WINDOW - On time!</span>`;
    }
  }
}

function showLegDetail(legIdx) {
  const trip = tripState.generatedTrip;
  if (!trip) return;
  
  trip.legs.forEach((_, idx) => {
    const tab = document.getElementById(`legTab${idx}`);
    if (tab) tab.className = idx === legIdx ? 'btn btn-primary' : 'btn btn-secondary';
  });
  
  const leg = trip.legs[legIdx];
  const container = document.getElementById('legDetailContainer');
  
  container.innerHTML = `
    <div style="background: var(--bg-elevated); padding: 12px; border-radius: 8px;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
        <span style="color: var(--accent-purple); font-weight: 600;">Leg ${leg.legNum}</span>
        <span style="color: var(--text-muted);">${Math.round(leg.totalMiles)} miles ‚Ä¢ ${formatTimeDisplay(leg.totalDriveMin)} drive</span>
      </div>
      <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.8em;">
        ${leg.events.map(e => `
          <div style="display: flex; gap: 12px; padding: 4px 0; border-bottom: 1px solid var(--border);">
            <span style="color: ${e.category === 'drive' ? 'var(--accent-green)' : e.category === 'on-duty' ? 'var(--accent-amber)' : 'var(--accent-purple)'}; min-width: 70px;">${e.segmentId}</span>
            <span style="min-width: 50px;">${e.startTime}</span>
            <span style="color: var(--text-muted);">‚Üí</span>
            <span style="min-width: 50px;">${e.endTime}</span>
            <span style="color: var(--text-secondary);">${e.notes}</span>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

// ==============================================
// STORAGE & SETTINGS
// ==============================================

function saveToStorage() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    document.getElementById('saveIndicator').textContent = 'üíæ Saved!';
    setTimeout(() => {
      document.getElementById('saveIndicator').textContent = 'üíæ Auto-saved';
    }, 1000);
  } catch (e) {
    console.warn('Storage not available:', e);
  }
}

function loadFromStorage() {
  try {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored) {
      const loaded = JSON.parse(stored);
      state = { ...state, ...loaded };
      return true;
    }
  } catch (e) {
    console.warn('Storage not available:', e);
  }
  return false;
}

function saveSettings() {
  state.settings.avgSpeed = parseInt(document.getElementById('settingAvgSpeed').value) || 55;
  state.settings.fudgeMin = parseInt(document.getElementById('settingFudge').value) || 30;
  state.settings.timezone = document.getElementById('settingTimezone').value;
  saveToStorage();
  alert('Settings saved!');
}

function clearAllData() {
  if (confirm('Clear ALL data? This cannot be undone.')) {
    state.events = [];
    state.theoryEvents = [];
    tripState.generatedTrip = null;
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }
}

function exportJSON() {
  const data = {
    version: SCHEMA.version,
    exportedAt: new Date().toISOString(),
    state: state,
    trip: tripState.generatedTrip
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `crystal_ball_v5_${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function importJSON(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const imported = JSON.parse(e.target.result);
      if (imported.state) {
        state = { ...state, ...imported.state };
        saveToStorage();
        alert('Data imported successfully!');
        location.reload();
      }
    } catch (err) {
      alert('Error importing file: ' + err.message);
    }
  };
  reader.readAsText(file);
}

// ==============================================
// INITIALIZATION
// ==============================================

function init() {
  loadFromStorage();
  updateTripPreview();
  
  // Apply settings to UI
  if (state.settings) {
    document.getElementById('settingAvgSpeed').value = state.settings.avgSpeed || 55;
    document.getElementById('settingFudge').value = state.settings.fudgeMin || 30;
    document.getElementById('settingTimezone').value = state.settings.timezone || 'America/New_York';
    document.getElementById('theoryAvgSpeed').value = state.settings.avgSpeed || 55;
    document.getElementById('theoryLifeHappens').value = state.settings.fudgeMin || 30;
  }
}

document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>